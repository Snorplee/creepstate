<!DOCTYPE html>
<html>
<head>
    <title>SIMILE Timeline Diagnostic</title>
    <script>
        // Set up Timeline configuration for local hosting
        window.Timeline_ajax_url = "simile-timeline/simile-ajax-api.js";
        window.Timeline_urlPrefix = "simile-timeline/api/";
        
        // Detailed logging
        var loadLog = [];
        function log(message) {
            loadLog.push(new Date().toISOString() + ": " + message);
            console.log(message);
            updateDisplay();
        }
        
        function updateDisplay() {
            var display = document.getElementById('log');
            if (display) {
                display.innerHTML = loadLog.join('<br>');
            }
        }
    </script>
    <script src="simile-timeline/simile-ajax-api.js" onload="log('Ajax API loaded')" onerror="log('ERROR: Ajax API failed to load')"></script>
    <script src="simile-timeline/api/timeline-api.js" onload="log('Timeline API loaded')" onerror="log('ERROR: Timeline API failed to load')"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #timeline { height: 400px; border: 1px solid #aaa; margin: 20px 0; }
        #log { background: #f5f5f5; padding: 15px; border: 1px solid #ddd; max-height: 300px; overflow-y: auto; }
        .test-button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <h1>SIMILE Timeline Diagnostic</h1>
    
    <div id="log">Loading...</div>
    
    <div>
        <button class="test-button" onclick="testAPIs()">Test APIs</button>
        <button class="test-button" onclick="testTimeline()">Test Timeline Creation</button>
        <button class="test-button" onclick="testXMLLoad()">Test XML Loading</button>
        <button class="test-button" onclick="clearLog()">Clear Log</button>
    </div>
    
    <div id="timeline"></div>
    
    <script>
        function clearLog() {
            loadLog = [];
            updateDisplay();
        }
        
        function testAPIs() {
            log("=== Testing APIs ===");
            log("SimileAjax available: " + (typeof SimileAjax !== 'undefined'));
            log("Timeline available: " + (typeof Timeline !== 'undefined'));
            
            if (typeof SimileAjax !== 'undefined') {
                log("SimileAjax.DateTime available: " + (typeof SimileAjax.DateTime !== 'undefined'));
                log("SimileAjax.XMLHttpRequest available: " + (typeof SimileAjax.XMLHttpRequest !== 'undefined'));
            }
            
            if (typeof Timeline !== 'undefined') {
                log("Timeline.DateTime available: " + (typeof Timeline.DateTime !== 'undefined'));
                log("Timeline.DefaultEventSource available: " + (typeof Timeline.DefaultEventSource !== 'undefined'));
                log("Timeline.create available: " + (typeof Timeline.create !== 'undefined'));
                log("Timeline.createBandInfo available: " + (typeof Timeline.createBandInfo !== 'undefined'));
            }
        }
        
        function testTimeline() {
            log("=== Testing Timeline Creation ===");
            
            if (typeof Timeline === 'undefined') {
                log("ERROR: Timeline not available");
                return;
            }
            
            try {
                var eventSource = new Timeline.DefaultEventSource();
                log("✓ EventSource created");
                
                // Create a simple test event
                var event = new Timeline.DefaultEventSource.Event({
                    start: new Date(2019, 0, 1),
                    instant: true,
                    text: "Test Event",
                    description: "This is a test event for diagnostic purposes"
                });
                
                eventSource.add(event);
                log("✓ Test event added to source");
                
                var bandInfos = [
                    Timeline.createBandInfo({
                        eventSource: eventSource,
                        date: new Date(2019, 0, 1),
                        width: "70%",
                        intervalUnit: Timeline.DateTime.MONTH,
                        intervalPixels: 100
                    }),
                    Timeline.createBandInfo({
                        eventSource: eventSource,
                        date: new Date(2019, 0, 1),
                        width: "30%",
                        intervalUnit: Timeline.DateTime.YEAR,
                        intervalPixels: 200
                    })
                ];
                
                bandInfos[1].syncWith = 0;
                bandInfos[1].highlight = true;
                
                log("✓ Band info created");
                
                var timeline = Timeline.create(document.getElementById("timeline"), bandInfos);
                log("✓ Timeline created successfully!");
                
            } catch (error) {
                log("ERROR in timeline creation: " + error.message);
                log("Error stack: " + error.stack);
            }
        }
        
        function testXMLLoad() {
            log("=== Testing XML Loading ===");
            
            if (typeof SimileAjax === 'undefined') {
                log("ERROR: SimileAjax not available for XML loading");
                return;
            }
            
            try {
                SimileAjax.XMLHttpRequest.get(
                    "timeline-comprehensive.xml",
                    function(error) {
                        log("ERROR loading XML: " + error);
                    },
                    function(xhr) {
                        log("✓ XML loaded successfully, response length: " + xhr.responseText.length);
                        
                        try {
                            var parser = new DOMParser();
                            var xmlDoc = parser.parseFromString(xhr.responseText, "text/xml");
                            var events = xmlDoc.getElementsByTagName("event");
                            log("✓ XML parsed, found " + events.length + " events");
                            
                            if (events.length > 0) {
                                var firstEvent = events[0];
                                log("First event title: " + firstEvent.getAttribute("title"));
                                log("First event start: " + firstEvent.getAttribute("start"));
                            }
                        } catch (parseError) {
                            log("ERROR parsing XML: " + parseError.message);
                        }
                    }
                );
            } catch (error) {
                log("ERROR in XML loading: " + error.message);
            }
        }
        
        // Auto-start diagnostics
        window.addEventListener('load', function() {
            log("=== Page Loaded ===");
            log("Starting diagnostics in 2 seconds...");
            setTimeout(function() {
                testAPIs();
            }, 2000);
        });
    </script>
</body>
</html>