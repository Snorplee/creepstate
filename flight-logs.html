<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✈️ Enhanced Flight Logs Investigation - Trump-Epstein Network</title>
    <script src="version.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <style>
        :root {
            --primary-color: #ff6b6b;
            --secondary-color: #4ecdc4;
            --accent-color: #45b7d1;
            --danger-color: #8B0000;
            --warning-color: #ffc107;
            --success-color: #28a745;
            --bg-dark: #1a1a1a;
            --text-light: #ffffff;
            --card-bg: #2d2d2d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: var(--text-light);
            line-height: 1.6;
            margin-top: 80px;
            overflow-anchor: none; /* Prevent scroll anchoring jumps */
        }

        /* Progressive Disclosure System */
        .user-mode-selector {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--card-bg);
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            padding: 15px;
            z-index: 9000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .user-mode-selector h4 {
            color: var(--primary-color);
            margin: 0 0 10px 0;
            font-size: 14px;
            text-align: center;
        }

        .mode-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .mode-button {
            padding: 8px 12px;
            border: 1px solid var(--secondary-color);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            text-align: center;
        }

        .mode-button:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .mode-button.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(255,107,107,0.3);
        }

        /* Progressive disclosure levels */
        .level-beginner .advanced-feature,
        .level-beginner .expert-feature {
            display: none !important;
        }

        .level-intermediate .expert-feature {
            display: none !important;
        }

        .level-advanced .beginner-only {
            opacity: 0.7;
        }

        .level-expert .beginner-only {
            opacity: 0.5;
        }

        /* Contextual help system */
        .help-tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: var(--accent-color);
            margin-left: 5px;
        }

        .help-tooltip:hover {
            color: var(--primary-color);
        }

        .help-content {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            padding: 12px;
            max-width: 300px;
            color: white;
            font-size: 13px;
            line-height: 1.4;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        .help-tooltip:hover .help-content {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(5px);
        }

        .help-content::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: var(--accent-color);
        }

        /* Universal Navigation */
        .universal-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--primary-color);
            z-index: 10000;
            padding: 10px 0;
        }

        .nav-container-universal {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .nav-brand {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-link-universal {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-link-universal:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        .nav-link-universal.active {
            background: var(--secondary-color);
        }

        .container {
            max-width: 1600px; /* Wider container for better space usage */
            margin: 0 auto;
            padding: 15px; /* Reduced padding */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* Flight Stats Dashboard */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px; /* Reduced gap */
            margin-bottom: 20px; /* Reduced margin */
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px; /* Reduced padding */
            text-align: center;
            border-left: 4px solid var(--primary-color);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255,107,107,0.2);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
        }

        .stat-label {
            color: var(--secondary-color);
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Interactive Map */
        #flightMap {
            height: 400px; /* Reduced height */
            border-radius: 10px;
            margin-bottom: 20px; /* Reduced margin */
            border: 2px solid var(--primary-color);
        }

        /* Flight Controls */
        .flight-controls {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px; /* Reduced padding */
            margin-bottom: 20px; /* Reduced margin */
        }

        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-group label {
            display: block;
            color: var(--secondary-color);
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .control-group input,
        .control-group select {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            color: white;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--danger-color);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: black;
        }

        /* Passenger Cards */
        .passenger-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Smaller cards */
            gap: 15px; /* Reduced gap */
            margin-bottom: 20px; /* Reduced margin */
            max-height: 600px; /* More reasonable height */
            overflow-y: auto; /* Add scroll if needed */
            overflow-x: hidden;
        }

        .passenger-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 12px; /* Reduced padding */
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .passenger-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
        }

        .passenger-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 0 auto 10px;
        }

        .passenger-name {
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
        }

        .passenger-stats {
            font-size: 0.85em;
            color: var(--secondary-color);
            text-align: center;
        }

        .flight-count {
            background: var(--danger-color);
            color: white;
            padding: 2px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            display: inline-block;
            margin-top: 5px;
        }

        /* Flight Table */
        .flights-table-container {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            overflow: auto;
            max-height: 600px;
            position: relative;
            /* Prevent layout jumps */
            min-height: 400px;
        }

        .flights-table {
            width: 100%;
            border-collapse: collapse;
        }

        .flights-table th {
            background: var(--primary-color);
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .flights-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .flights-table tr:hover {
            background: rgba(255,107,107,0.1);
        }

        .passenger-tag {
            display: inline-block;
            background: var(--accent-color);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            margin: 2px;
        }

        .vip-tag {
            background: var(--warning-color);
            color: black;
        }

        .suspicious-tag {
            background: var(--danger-color);
        }
        
        .hoverable-passenger {
            cursor: help;
            border-bottom: 1px dotted rgba(255,255,255,0.6);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .hoverable-passenger:hover {
            background: var(--warning-color) !important;
            color: black !important;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(255,193,7,0.4);
            border-bottom: 1px solid var(--warning-color);
        }
        
        /* Enhanced tooltip styling */
        .hoverable-passenger[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            max-width: 300px;
            white-space: normal;
            word-wrap: break-word;
            z-index: 6000;
            border: 1px solid var(--primary-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        /* Tooltip arrow */
        .hoverable-passenger[title]:hover::before {
            content: '';
            position: absolute;
            bottom: 92%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--primary-color);
            z-index: 6100;
        }
        
        /* Bio-clickable passengers */
        .bio-clickable {
            cursor: pointer !important;
            position: relative;
        }
        
        .bio-clickable:hover {
            box-shadow: 0 0 10px rgba(255,193,7,0.6) !important;
            border: 1px solid var(--warning-color) !important;
        }
        
        .bio-clickable::after {
            content: '🔍';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .bio-clickable:hover::after {
            opacity: 1;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            height: 350px; /* Fixed height to prevent stretching */
            position: relative;
        }
        
        .chart-container canvas {
            max-height: 280px !important; /* Constrain canvas height */
        }

        .chart-title {
            color: var(--primary-color);
            font-size: 1.2em;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Animation */
        @keyframes flightPath {
            0% { stroke-dashoffset: 1000; }
            100% { stroke-dashoffset: 0; }
        }

        .flight-path {
            stroke: var(--primary-color);
            stroke-width: 2;
            fill: none;
            stroke-dasharray: 1000;
            animation: flightPath 2s ease-in-out;
        }

        /* Loading Animation */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            display: none;
            z-index: 9500;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Heat Map Legend */
        .heatmap-legend {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            z-index: 6000;
        }

        .heatmap-legend h4 {
            margin: 0 0 10px 0;
            color: white;
            font-size: 14px;
        }

        .legend-gradient {
            width: 200px;
            height: 20px;
            background: linear-gradient(to right, blue, cyan, lime, yellow, red);
            border-radius: 3px;
        }

        .legend-labels {
            display: flex;
            justify-content: space-between;
            color: white;
            font-size: 12px;
            margin-top: 5px;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 40px 20px;
            background: rgba(0,0,0,0.5);
            margin-top: 60px;
        }
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }
        .footer-link {
            color: var(--secondary-color);
            text-decoration: none;
        }
        .footer-link:hover {
            color: var(--primary-color);
        }
        
        /* Footer Navigation Menu */
        .footer-nav {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            margin: 40px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .footer-nav-title {
            color: var(--primary-color);
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .footer-nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .footer-nav-section {
            text-align: left;
        }
        
        .footer-nav-section h4 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 5px;
        }
        
        .footer-nav-links {
            list-style: none;
        }
        
        .footer-nav-links li {
            margin-bottom: 8px;
        }
        
        .footer-nav-links a {
            color: #ccc;
            text-decoration: none;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .footer-nav-links a:hover {
            color: var(--primary-color);
        }

        /* Back to Top Button */
        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: none;
            transition: all 0.3s ease;
            z-index: 6000;
        }
        
        .back-to-top:hover {
            background: var(--danger-color);
            transform: scale(1.1);
        }

        /* Airport Code Tooltips */
        .airport-code {
            position: relative;
            cursor: help;
            color: var(--accent-color);
            border-bottom: 1px dotted var(--accent-color);
            font-weight: bold;
        }

        .airport-code:hover {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .airport-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            color: white;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid var(--accent-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            white-space: nowrap;
            z-index: 6000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            font-size: 0.9em;
            max-width: 300px;
            white-space: normal;
            line-height: 1.4;
            pointer-events: none;
        }

        .airport-code:hover .airport-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-5px);
        }

        .airport-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--accent-color);
        }

        .airport-name {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .airport-location {
            color: var(--secondary-color);
            font-size: 0.9em;
            margin-bottom: 4px;
        }

        .airport-description {
            color: #ccc;
            font-size: 0.85em;
        }

        /* Brushing and Linking Styles */
        .brushing-enabled .passenger-card {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .brushing-enabled .passenger-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,107,107,0.3);
        }

        .passenger-card.selected {
            border-color: var(--success-color) !important;
            background: rgba(40,167,69,0.1) !important;
            box-shadow: 0 0 10px rgba(40,167,69,0.5) !important;
        }

        .passenger-card.dimmed {
            opacity: 0.4;
            filter: grayscale(0.5);
        }

        .highlighted-row {
            background: rgba(255,193,7,0.2) !important;
            border-left: 4px solid var(--warning-color) !important;
        }

        .selection-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success-color);
            display: none;
            z-index: 10;
            color: white;
            font-weight: bold;
            font-size: 10px;
            align-items: center;
            justify-content: center;
        }

        .selected .selection-indicator {
            display: flex;
        }

        .selected .selection-indicator::after {
            content: '✓';
        }

        /* Evidence Classification Styles */
        .reliability-indicator {
            transition: transform 0.2s ease;
        }

        .reliability-indicator:hover {
            transform: scale(1.2);
        }

        .flights-table tr {
            position: relative;
        }

        .confidence-high {
            border-left: 3px solid var(--success-color) !important;
        }

        .confidence-medium {
            border-left: 3px solid var(--warning-color) !important;
        }

        .confidence-low {
            border-left: 3px solid var(--danger-color) !important;
        }

        /* Accessibility Enhancements */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--primary-color);
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 10001;
            transition: top 0.3s;
        }

        .skip-link:focus {
            top: 6px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --primary-color: #000000;
                --secondary-color: #ffffff;
                --accent-color: #0000ff;
                --bg-dark: #ffffff;
                --text-light: #000000;
                --card-bg: #f0f0f0;
            }
            
            .passenger-card {
                border: 2px solid #000000;
            }
            
            .btn {
                border: 2px solid #000000;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
            
            .flight-path,
            .loading-spinner {
                animation: none;
            }
        }

        /* Focus indicators */
        button:focus,
        input:focus,
        select:focus,
        .passenger-card:focus,
        .nav-link-universal:focus {
            outline: 3px solid var(--accent-color);
            outline-offset: 2px;
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Keyboard navigation indicators */
        .keyboard-navigation .passenger-card:focus {
            box-shadow: 0 0 0 3px var(--accent-color);
        }
    </style>
</head>
<body>
    <!-- Universal Navigation -->
    <nav class="universal-nav">
        <div class="nav-container-universal">
            <a href="index.html" class="nav-brand">
                🔍 Trump-Epstein Investigation
            </a>
            <div class="nav-links">
                <a href="index.html" class="nav-link-universal">Home</a>
                <a href="timeline.html" class="nav-link-universal">Timeline</a>
                <a href="enhanced-visualizations.html" class="nav-link-universal">Network</a>
                <a href="flight-logs.html" class="nav-link-universal active">✈️ Flight Logs</a>
                <a href="vertical-timeline.html" class="nav-link-universal">Vertical</a>
                <a href="stats.html" class="nav-link-universal">Statistics</a>
                <a href="name-the-scandal.html" class="nav-link-universal">🏆 Name It!</a>
            </div>
        </div>
    </nav>

    <!-- Skip to main content link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Mobile Loading Indicator -->
    <div class="mobile-loading" id="mobileLoading">
        <div class="loading-spinner"></div>
        <p>Loading flight data...</p>
    </div>

    <main id="main-content" class="container" role="main" aria-label="Flight logs investigation dashboard">
        <!-- User Mode Selector -->
        <div class="user-mode-selector" id="userModeSelector" role="radiogroup" aria-labelledby="experience-level-label">
            <h4 id="experience-level-label">Experience Level</h4>
            <div class="mode-buttons" role="group">
                <button class="mode-button active" data-mode="beginner" onclick="setUserMode('beginner')" role="radio" aria-checked="true" aria-describedby="beginner-desc">
                    🟢 Beginner
                    <span id="beginner-desc" class="sr-only">Simplified interface with essential features only</span>
                </button>
                <button class="mode-button" data-mode="intermediate" onclick="setUserMode('intermediate')" role="radio" aria-checked="false" aria-describedby="intermediate-desc">
                    🟡 Intermediate
                    <span id="intermediate-desc" class="sr-only">Added charts and passenger analysis</span>
                </button>
                <button class="mode-button" data-mode="advanced" onclick="setUserMode('advanced')" role="radio" aria-checked="false" aria-describedby="advanced-desc">
                    🟠 Advanced
                    <span id="advanced-desc" class="sr-only">Network analysis and statistical tools</span>
                </button>
                <button class="mode-button" data-mode="expert" onclick="setUserMode('expert')" role="radio" aria-checked="false" aria-describedby="expert-desc">
                    🔴 Expert
                    <span id="expert-desc" class="sr-only">Full investigative toolkit with all features</span>
                </button>
            </div>
        </div>

        <h1 style="text-align: center; color: var(--primary-color); margin-bottom: 30px;">
            ✈️ Enhanced Flight Logs Investigation Platform
            <span class="help-tooltip" role="tooltip" aria-describedby="platform-help">ℹ️
                <div class="help-content" id="platform-help">
                    <strong>Investigation Platform:</strong><br>
                    Analyze Epstein flight logs with advanced filtering, network analysis, and timeline visualization. Use the Experience Level selector (top-right) to show/hide complexity based on your expertise.
                </div>
            </span>
        </h1>
        
        <!-- Screen reader description -->
        <div class="sr-only">
            This is an interactive investigation platform for analyzing Jeffrey Epstein's flight logs. 
            The platform includes flight data visualization, passenger analysis, network connections, 
            and statistical analysis tools. Use keyboard navigation to access all features.
        </div>

        <!-- Statistics Dashboard -->
        <div class="stats-dashboard">
            <div class="stat-card">
                <span class="stat-number" id="totalFlights">0</span>
                <div class="stat-label">Total Flights</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="uniquePassengers">0</span>
                <div class="stat-label">Unique Passengers</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="frequentFlyers">0</span>
                <div class="stat-label">Frequent Flyers (10+ flights)</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="destinations">0</span>
                <div class="stat-label">Destinations</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="vipFlights">0</span>
                <div class="stat-label">VIP Flights</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="suspiciousFlights">0</span>
                <div class="stat-label">🚨 Suspicious Patterns</div>
            </div>
        </div>

        <!-- Flight Controls -->
        <div class="flight-controls">
            <h3 style="color: var(--primary-color); margin-bottom: 15px;">
                🔍 Search & Filter Flights
                <span class="help-tooltip">ℹ️
                    <div class="help-content">
                        <strong>Search Tips:</strong><br>
                        • Passenger Name: Search for specific individuals<br>
                        • Date Range: Filter by time periods<br>
                        • Destination: Focus on specific locations<br>
                        • Use "Suspicious Only" to find concerning patterns
                    </div>
                </span>
            </h3>
            <div class="control-row">
                <div class="control-group">
                    <label>Passenger Name</label>
                    <input type="text" id="passengerSearch" placeholder="Search passengers...">
                </div>
                <div class="control-group">
                    <label>Date Range</label>
                    <input type="date" id="startDate">
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <input type="date" id="endDate">
                </div>
                <div class="control-group">
                    <label>Destination</label>
                    <select id="destinationFilter">
                        <option value="">All Destinations</option>
                    </select>
                </div>
            </div>
            <div class="control-row">
                <button class="btn btn-primary" onclick="searchFlights()">🔍 Search</button>
                <button class="btn btn-secondary" onclick="resetFilters()">↻ Reset</button>
                <button class="btn btn-warning" onclick="showSuspiciousOnly()">🚨 Suspicious Only</button>
                <button class="btn btn-primary advanced-feature" onclick="animateFlights()">▶️ Animate Flights</button>
                <button class="btn btn-secondary advanced-feature" onclick="exportData()">📥 Export Data</button>
                <button class="btn btn-primary expert-feature" onclick="showNetworkAnalysis()">🕸️ Network Analysis</button>
                <button class="btn btn-secondary expert-feature" onclick="showStatisticalAnalysis()">📊 Statistical Analysis</button>
                <button class="btn btn-primary advanced-feature" onclick="toggleBrushingMode()" id="brushingToggle">🎨 Brushing Mode</button>
                <button class="btn btn-secondary advanced-feature" onclick="showEvidenceClassificationPanel()">🏆 Evidence Quality</button>
            </div>
        </div>

        <!-- Enhanced Interactive Map Section -->
        <div class="map-section advanced-feature">
            <div class="map-controls expert-feature">
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">
                    🗺️ Interactive Flight Map
                    <span class="help-tooltip">ℹ️
                        <div class="help-content">
                            <strong>Map Features:</strong><br>
                            • Toggle map layers (satellite, terrain, dark)<br>
                            • Use time slider to see flights chronologically<br>
                            • Click flight paths for detailed information<br>
                            • Zoom and pan to explore different regions
                        </div>
                    </span>
                </h3>
                
                <div class="map-control-row">
                    <div class="control-group">
                        <label>Map Layer</label>
                        <select id="mapLayerSelector" onchange="switchMapLayer(this.value)">
                            <option value="dark">Dark Theme</option>
                            <option value="light">Light Theme</option>
                            <option value="satellite">Satellite</option>
                            <option value="terrain">Terrain</option>
                        </select>
                    </div>
                    
                    <div class="control-group expert-feature">
                        <label>Flight Overlay</label>
                        <select id="overlaySelector" onchange="switchOverlay(this.value)">
                            <option value="paths">Flight Paths</option>
                            <option value="heatmap">Heat Map</option>
                            <option value="clusters">Airport Clusters</option>
                            <option value="all">All Overlays</option>
                        </select>
                    </div>
                    
                    <div class="control-group expert-feature">
                        <button class="btn btn-secondary" onclick="toggleTimeSlider()">
                            ⏱️ Time Slider
                        </button>
                        <button class="btn btn-secondary" onclick="toggle3DView()">
                            🌍 3D View
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Time Slider Control (Expert Feature) -->
            <div class="time-slider-container expert-feature" id="timeSliderContainer" style="display: none;">
                <div class="time-controls">
                    <h4 style="color: var(--accent-color); margin-bottom: 10px;">Timeline Control</h4>
                    <div class="slider-row">
                        <button class="btn-small" onclick="playTimelineAnimation()" id="playButton">▶️</button>
                        <input type="range" id="timeSlider" min="0" max="100" value="0" oninput="updateTimelinePosition(this.value)" class="timeline-slider">
                        <select id="playbackSpeed" onchange="setPlaybackSpeed(this.value)">
                            <option value="0.5">0.5x</option>
                            <option value="1" selected>1x</option>
                            <option value="2">2x</option>
                            <option value="5">5x</option>
                            <option value="10">10x</option>
                        </select>
                    </div>
                    <div class="time-display">
                        <span id="currentTimeDisplay">Select time period</span>
                        <span id="totalFlightsDisplay">0 flights visible</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map Container -->
        <div id="flightMap"></div>
        
        <!-- Enhanced Map Legends -->
        <div class="map-legend-container">
            <div class="heatmap-legend" id="heatmapLegend" style="display: none;">
                <h4>Flight Frequency</h4>
                <div class="legend-gradient"></div>
                <div class="legend-labels">
                    <span>Low</span>
                    <span>Medium</span>
                    <span>High</span>
                </div>
            </div>
            
            <div class="flight-path-legend expert-feature" id="flightPathLegend">
                <h4>Flight Routes</h4>
                <div class="legend-item"><span class="legend-color" style="background: #ff0000;"></span> Virgin Islands (High Risk)</div>
                <div class="legend-item"><span class="legend-color" style="background: #ff6b6b;"></span> Private Islands</div>
                <div class="legend-item"><span class="legend-color" style="background: #ffa500;"></span> Frequent Routes</div>
                <div class="legend-item"><span class="legend-color" style="background: #800080;"></span> International</div>
                <div class="legend-item"><span class="legend-color" style="background: #4ecdc4;"></span> Domestic</div>
            </div>
        </div>

        <!-- All Passengers -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: var(--primary-color); margin: 0;">👥 All Passengers</h2>
            <div style="display: flex; gap: 15px; align-items: center;">
                <input type="text" id="passengerNameSearch" placeholder="Search passengers..." style="
                    padding: 8px 12px;
                    background: rgba(255,255,255,0.1);
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: 20px;
                    color: white;
                    width: 200px;
                " onkeyup="searchPassengers()">
                <select id="passengerSort" onchange="sortPassengers()" style="
                    padding: 8px 12px;
                    background: rgba(255,255,255,0.1);
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: 5px;
                    color: white;
                ">
                    <option value="flights">Sort by Flight Count</option>
                    <option value="name">Sort by Name A-Z</option>
                    <option value="name-desc">Sort by Name Z-A</option>
                </select>
            </div>
        </div>
        <div class="passenger-grid" id="passengerGrid">
            <!-- Will be populated dynamically -->
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3 class="chart-title">📊 Flights Over Time</h3>
                <canvas id="flightsTimeChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">🌍 Top Destinations</h3>
                <canvas id="destinationsChart"></canvas>
            </div>
        </div>

        <!-- Flight Table -->
        <div class="flights-table-container">
            <h3 style="color: var(--primary-color); margin-bottom: 15px;">📋 Flight Manifest</h3>
            <table class="flights-table" id="flightsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Flight #</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Passengers</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="flightsTableBody">
                    <!-- Will be populated dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Keyboard shortcuts help -->
    <div style="position: fixed; bottom: 10px; right: 120px; z-index: 1000;">
        <button onclick="showKeyboardShortcuts()" style="
            background: var(--accent-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        " title="Keyboard shortcuts (?)" aria-label="Show keyboard shortcuts">
            ?
        </button>
    </div>

    <!-- Footer Navigation Menu -->
    <div class="footer-nav">
        <h3 class="footer-nav-title">🧭 Site Navigation</h3>
        <div class="footer-nav-grid">
            <div class="footer-nav-section">
                <h4>🔍 Investigation Tools</h4>
                <ul class="footer-nav-links">
                    <li><a href="timeline.html">📅 Interactive Timeline</a></li>
                    <li><a href="vertical-timeline.html">📜 Vertical Timeline</a></li>
                    <li><a href="enhanced-visualizations.html">🌐 Network Analysis</a></li>
                    <li><a href="flight-logs.html">✈️ Flight Log Analysis</a></li>
                </ul>
            </div>
            <div class="footer-nav-section">
                <h4>📊 Data & Statistics</h4>
                <ul class="footer-nav-links">
                    <li><a href="stats.html">📊 Investigation Statistics</a></li>
                    <li><a href="names-and-shame.html">👥 Associates Directory</a></li>
                    <li><a href="slideshow-timeline.html">🎬 Slideshow Presentation</a></li>
                </ul>
            </div>
            <div class="footer-nav-section">
                <h4>🎯 Resources & Support</h4>
                <ul class="footer-nav-links">
                    <li><a href="resources.html">🆘 Victim Resources</a></li>
                    <li><a href="index.html#documentation">📖 Documentation</a></li>
                    <li><a href="name-the-scandal.html">🏆 Name The Scandal</a></li>
                </ul>
            </div>
            <div class="footer-nav-section">
                <h4>🔗 External Links</h4>
                <ul class="footer-nav-links">
                    <li><a href="https://github.com/yourusername/creepstate" target="_blank">💻 GitHub Repository</a></li>
                    <li><a href="https://www.epsteincompensationfund.com" target="_blank">💰 Victim Compensation</a></li>
                    <li><a href="https://www.courtlistener.com" target="_blank">⚖️ Court Documents</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="footer-links">
            <a href="index.html#documentation" class="footer-link">Documentation</a>
            <a href="resources.html" class="footer-link">Resources</a>
            <a href="https://github.com/yourusername/creepstate" class="footer-link">GitHub</a>
            <a href="#" class="footer-link">Report Issue</a>
        </div>
        <p style="color: #666;">© 2025 Trump-Epstein Investigation | For Truth and Justice</p>
        <p style="color: #666; font-size: 0.9em; margin-top: 10px;">
            This resource compiles publicly available information for educational and journalistic purposes.
        </p>
    </footer>
    
    <!-- Back to Top Button -->
    <button class="back-to-top" id="backToTop" onclick="scrollToTop()">↑</button>

    <script>
        // Global variables
        let map;
        let flightData = [];
        let passengerData = {};
        let flightPaths = [];
        let heatmapLayer;
        let currentAnimation = null;
        let isUpdating = false; // Flag to prevent scroll issues during updates
        let currentUserMode = 'beginner'; // Progressive disclosure state
        let userPreferences = {}; // User settings and preferences
        let searchHistory = []; // Search history for auto-complete
        
        // Enhanced map variables
        let mapLayers = {};
        let currentMapLayer = 'dark';
        let currentOverlay = 'paths';
        let timelineData = [];
        let currentTimeIndex = 0;
        let timelineAnimation = null;
        let playbackSpeed = 1;
        let is3DMode = false;
        let clusterLayer = null;
        
        // Brushing and Linking System
        let selectedPassengers = new Set();
        let selectedDateRange = null;
        let selectedRoutes = new Set();
        let linkedSelections = {
            passengers: new Set(),
            dates: null,
            routes: new Set(),
            flights: new Set()
        };
        let brushingEnabled = true;
        let selectionHistory = [];
        
        // Evidence Classification System
        let evidenceReliabilityScores = {
            // Verified sources (court documents, testimony)
            'verified': 1.0,
            // Probable sources (flight logs, documented meetings)
            'probable': 0.8,
            // Unverified but consistent (media reports, witness accounts)
            'unverified': 0.6,
            // Disputed or contradictory
            'disputed': 0.3
        };
        
        let dataSourceClassification = {};
        let confidenceThresholds = {
            high: 0.8,
            medium: 0.6,
            low: 0.4
        };
        
        // Comprehensive passenger identification database - decoded from court documents and testimonies
        const passengerIdentities = {
            // Coded passengers from flight logs
            'A P': 'Prince Andrew (Duke of York) - Member of British Royal Family',
            'A S': 'Adriana Mucinska - Epstein associate and frequent traveler',
            'A M': 'Adriana Mucinska - Epstein associate and frequent traveler',
            'D B': 'Virginia Giuffre (formerly Roberts) - Key accuser and trafficking victim',
            'J K': 'Jane Doe #3 - Victim in court documents',
            'AP': 'Prince Andrew (Duke of York) - Member of British Royal Family',
            'AS': 'Adriana Mucinska - Epstein associate and frequent traveler',
            'AM': 'Adriana Mucinska - Epstein associate and frequent traveler',
            'DB': 'Virginia Giuffre (formerly Roberts) - Key accuser and trafficking victim',
            'JK': 'Jane Doe #3 - Victim in court documents',
            
            // Unidentified passengers
            '1 Female': 'Unidentified Female Passenger - Potential victim',
            '2 Female': 'Two Unidentified Female Passengers - Potential victims',
            '3 Female': 'Three Unidentified Female Passengers - Potential victims',
            'Female': 'Unidentified Female Passenger - Potential victim',
            'Margaret': 'Margaret - Unidentified female associate',
            'Warren': 'Warren - Possibly Warren Buffett (unconfirmed)',
            'Roger': 'Roger - Unidentified male associate',
            'Deborah': 'Deborah - Unidentified female passenger',
            
            // Core Epstein Network
            'Jeff Epstein': 'Jeffrey Epstein - Convicted sex trafficker and financier',
            'Jeffrey Epstein': 'Jeffrey Epstein - Convicted sex trafficker and financier',
            'Ghislaine Maxwell': 'Ghislaine Maxwell - Convicted trafficker, daughter of Robert Maxwell',
            'Sarah Kellen': 'Sarah Kellen - Epstein\'s scheduler and alleged procurer',
            'Nadia Marcinkova': 'Nadia Marcinkova - Epstein pilot and alleged victim-turned-recruiter',
            
            // High-profile passengers
            'Alan Dershowitz': 'Alan Dershowitz - Harvard Law professor and Epstein\'s attorney',
            'Larry Summers': 'Larry Summers - Former Treasury Secretary and Harvard president',
            'Glenn Dubin': 'Glenn Dubin - Hedge fund manager and Epstein associate',
            'Eva Dubin': 'Eva Dubin - Wife of Glenn Dubin, former Miss Sweden',
            'Celina Dubin': 'Celina Dubin - Daughter of Glenn and Eva Dubin',
            'Alan Greenberg': 'Alan Greenberg - Former CEO of Bear Stearns',
            'Kathy Greenberg': 'Kathy Greenberg - Wife of Alan Greenberg',
            
            // Models and associates
            'Sophie Biddle': 'Sophie Biddle - Model and Epstein associate',
            'Gwendolyn Beck': 'Gwendolyn Beck - Epstein associate and frequent traveler',
            'Adriana Mucinska': 'Adriana Mucinska - Eastern European associate of Epstein',
            'Tatiana Kovylina': 'Tatiana Kovylina - Young associate of Epstein',
            'Natalie Simanova': 'Natalie Simanova - Young associate, possible victim',
            'Alexia Wallert': 'Alexia Wallert - Young passenger, possible victim',
            'Cindy Lopez': 'Cindy Lopez - Young passenger, possible victim',
            
            // Staff and crew
            'Larry Visoski': 'Larry Visoski - Chief pilot who testified in Maxwell trial',
            'Bill Hammond': 'Bill Hammond - Epstein pilot and aircraft mechanic',
            'Valdson Cotrin': 'Valdson Cotrin - Security personnel',
            'Mark Tagoya': 'Mark Tagoya - Security personnel',
            'Manny': 'Manny - Security/maintenance staff',
            
            // Business associates
            'Chuck Schumi': 'Chuck Schumi - Business associate, limited information',
            'David Anton': 'David Anton - Business associate, limited information',
            'Bill Murphy': 'Bill Murphy - Business associate who traveled with Maxwell',
            'Alex Resnick': 'Alex Resnick - Business associate, limited information',
            'Matt Grippi': 'Matt Grippi - Business associate, limited information',
            'Igor Zinoviev': 'Igor Zinoviev - Eastern European associate',
            
            // Additional passengers from logs
            'Lisa Summers': 'Lisa Summers - Wife of Larry Summers',
            'Jean Luc Brunel': 'Jean Luc Brunel - Modeling agent (deceased), trafficking allegations',
            'Marvin Minsky': 'Marvin Minsky - MIT AI pioneer (deceased)',
            'John Brockman': 'John Brockman - Literary agent and Edge Foundation founder',
            'Nicole Junkermann': 'Nicole Junkermann - German investor',
            'Clare Hazell': 'Clare Hazell - Epstein associate',
            'Kelly Spamm': 'Kelly Spamm - Young passenger, limited information',
            'Hazel': 'Hazel - Young passenger, limited information',
            'Emmy': 'Emmy - Young passenger, limited information',
            'Anna': 'Anna - Young passenger, limited information',
            'Svetlana': 'Svetlana - Eastern European passenger, limited information',
            'Elena': 'Elena - Young passenger, limited information'
        };

        // Airport coordinates - expanded list
        const airports = {
            'TEB': { 
                lat: 40.8501, lng: -74.0608, 
                name: 'Teterboro Airport', 
                location: 'Teterboro, New Jersey, USA',
                description: 'Private jet hub serving NYC metropolitan area, frequent Epstein destination'
            },
            'PBI': { 
                lat: 26.6832, lng: -80.0956, 
                name: 'Palm Beach International Airport', 
                location: 'West Palm Beach, Florida, USA',
                description: 'Major airport near Trump\'s Mar-a-Lago resort and Epstein\'s Palm Beach mansion'
            },
            'EWR': { 
                lat: 40.6925, lng: -74.1687, 
                name: 'Newark Liberty International Airport', 
                location: 'Newark, New Jersey, USA',
                description: 'Major international airport serving New York City area'
            },
            'JFK': { 
                lat: 40.6413, lng: -73.7781, 
                name: 'John F. Kennedy International Airport', 
                location: 'Queens, New York, USA',
                description: 'Primary international airport for New York City'
            },
            'LGA': { 
                lat: 40.7772, lng: -73.8726, 
                name: 'LaGuardia Airport', 
                location: 'Queens, New York, USA',
                description: 'Domestic hub airport serving New York City'
            },
            'TIST': { 
                lat: 18.3373, lng: -64.9733, 
                name: 'Cyril E. King Airport', 
                location: 'St. Thomas, U.S. Virgin Islands',
                description: 'Gateway to Epstein\'s Little St. James island - most suspicious destination'
            },
            'CMH': { 
                lat: 39.9980, lng: -82.8919, 
                name: 'John Glenn Columbus International Airport', 
                location: 'Columbus, Ohio, USA',
                description: 'Major airport serving central Ohio'
            },
            'MBPV': { 
                lat: 21.7736, lng: -72.2659, 
                name: 'Providenciales International Airport', 
                location: 'Turks and Caicos Islands',
                description: 'Caribbean destination in the British Overseas Territory'
            },
            'BED': { 
                lat: 42.4696, lng: -71.2890, 
                name: 'Hanscom Field', 
                location: 'Bedford, Massachusetts, USA',
                description: 'General aviation airport serving Boston area'
            },
            'OPF': { 
                lat: 25.9072, lng: -80.2784, 
                name: 'Opa-locka Executive Airport', 
                location: 'Opa-locka, Florida, USA',
                description: 'Executive airport in Miami-Dade County'
            },
            'OQU': { lat: 41.5243, lng: -71.4118, name: 'Quonset State Airport, RI' },
            'SAF': { lat: 35.6175, lng: -106.0881, name: 'Santa Fe Regional, NM' },
            'DCA': { lat: 38.8521, lng: -77.0402, name: 'Ronald Reagan Washington National' },
            'BOS': { lat: 42.3656, lng: -71.0096, name: 'Boston Logan International' },
            'LAX': { lat: 33.9425, lng: -118.4081, name: 'Los Angeles International' },
            'LHR': { lat: 51.4700, lng: -0.4543, name: 'London Heathrow' },
            'CDG': { lat: 49.0097, lng: 2.5479, name: 'Paris Charles de Gaulle' },
            'CYUL': { lat: 45.4706, lng: -73.7408, name: 'Montreal Trudeau International' },
            'TEb': { lat: 40.8501, lng: -74.0608, name: 'Teterboro Airport, NJ' }, // Lowercase variant in data
            'HPN': { lat: 41.0670, lng: -73.7076, name: 'Westchester County Airport, NY' }
        };

        // Enhanced Map Initialization
        function initializeMap() {
            map = L.map('flightMap', {
                zoomControl: true,
                scrollWheelZoom: true,
                doubleClickZoom: true,
                touchZoom: true,
                dragging: true
            }).setView([35, -60], 4);
            
            // Initialize map layers
            initializeMapLayers();
            
            // Set default layer
            switchMapLayer('dark');

            // Add enhanced airport markers
            addAirportMarkers();
            
            // Initialize timeline data
            prepareTimelineData();
        }

        // Load flight data
        async function loadFlightData() {
            try {
                // Load CSV data
                const response = await fetch('flight_flights_table_updated.csv');
                const csvText = await response.text();
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = parseCSVLine(lines[i]);
                        
                        // Skip invalid or header rows
                        if (!values[0] || values[0] === 'Date' || !/^\d{8}$/.test(values[0])) {
                            continue;
                        }
                        
                        const flight = {
                            date: values[0],
                            flightNo: values[1],
                            from: values[2] ? values[2].trim() : '',
                            to: values[3] ? values[3].trim() : '',
                            passengers: parsePassengers(values[4])
                        };
                        
                        // Only add flights with valid data
                        if (flight.from && flight.to && flight.date) {
                            flightData.push(flight);
                        }
                        
                        // Track passenger data
                        flight.passengers.forEach(passenger => {
                            if (!passengerData[passenger]) {
                                passengerData[passenger] = {
                                    name: passenger,
                                    flights: [],
                                    count: 0
                                };
                            }
                            passengerData[passenger].flights.push(flight);
                            passengerData[passenger].count++;
                        });
                    }
                }
                
                // Sort flights by date for proper chronological display
                flightData.sort((a, b) => a.date.localeCompare(b.date));
                
                console.log(`✅ Loaded ${flightData.length} flights from CSV data`);
                console.log(`📅 Date range: ${flightData[0]?.date} to ${flightData[flightData.length - 1]?.date}`);
                console.log(`🔍 First 5 flights:`, flightData.slice(0, 5).map(f => `${f.date} ${f.flightNo}`));
                console.log(`🔍 Last 5 flights:`, flightData.slice(-5).map(f => `${f.date} ${f.flightNo}`));
                
                // Debug passenger counts
                const topPassengers = Object.entries(passengerData)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 10);
                console.log('🧑‍💼 Top 10 passengers by flight count:');
                topPassengers.forEach(([name, data]) => {
                    console.log(`  ${name}: ${data.count} flights`);
                });
                
                // Draw flight paths from CSV data
                drawFlightPaths();
                
                // Load KML data (if available)
                await loadKMLData();
                
                updateStatistics();
                displayFlights();
                displayPassengers();
                createCharts();
                
            } catch (error) {
                console.error('Error loading flight data:', error);
                showNotification('Error loading flight data', 'error');
            }
        }

        // Parse CSV line handling quotes
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // Parse passenger list
        function parsePassengers(passengerString) {
            if (!passengerString) return [];
            return passengerString.split(',').map(p => p.trim()).filter(p => p);
        }

        // Draw flight paths from CSV data
        function drawFlightPaths() {
            console.log(`Drawing ${flightData.length} flight paths from CSV data`);
            
            // Clear existing paths
            flightPaths.forEach(path => map.removeLayer(path));
            flightPaths = [];
            
            // Group flights by route for different colors
            const routeGroups = {
                'virgin_islands': [], // Flights to/from TIST (Virgin Islands)
                'private_islands': [], // Flights to/from MBPV (Turks & Caicos)
                'frequent_routes': [], // Most common routes
                'international': [], // International flights
                'domestic': [] // Regular domestic flights
            };
            
            flightData.forEach(flight => {
                const fromAirport = airports[flight.from] || airports[flight.from.toUpperCase()];
                const toAirport = airports[flight.to] || airports[flight.to.toUpperCase()];
                
                if (!fromAirport || !toAirport) {
                    console.warn(`Missing airport data for ${flight.from} to ${flight.to}`);
                    return;
                }
                
                // Categorize the flight
                if (flight.from === 'TIST' || flight.to === 'TIST') {
                    routeGroups.virgin_islands.push(flight);
                } else if (flight.from === 'MBPV' || flight.to === 'MBPV') {
                    routeGroups.private_islands.push(flight);
                } else if (flight.from.includes('LHR') || flight.to.includes('LHR') || 
                          flight.from.includes('CDG') || flight.to.includes('CDG')) {
                    routeGroups.international.push(flight);
                } else if ((flight.from === 'TEB' && flight.to === 'PBI') || 
                          (flight.from === 'PBI' && flight.to === 'TEB')) {
                    routeGroups.frequent_routes.push(flight);
                } else {
                    routeGroups.domestic.push(flight);
                }
            });
            
            // Define colors for each route type
            const routeColors = {
                'virgin_islands': '#ff0000', // Red - high concern
                'private_islands': '#ff6b6b', // Light red - suspicious
                'frequent_routes': '#ffa500', // Orange - frequent pattern
                'international': '#800080', // Purple - international
                'domestic': '#4ecdc4' // Cyan - regular domestic
            };
            
            // Draw paths for each group
            Object.keys(routeGroups).forEach(groupName => {
                const flights = routeGroups[groupName];
                const color = routeColors[groupName];
                
                flights.forEach(flight => {
                    const fromAirport = airports[flight.from] || airports[flight.from.toUpperCase()];
                    const toAirport = airports[flight.to] || airports[flight.to.toUpperCase()];
                    
                    if (fromAirport && toAirport) {
                        // Create curved path for better visualization
                        const latlngs = [[fromAirport.lat, fromAirport.lng], [toAirport.lat, toAirport.lng]];
                        
                        const polyline = L.polyline(latlngs, {
                            color: color,
                            weight: groupName === 'virgin_islands' ? 3 : 2,
                            opacity: groupName === 'virgin_islands' || groupName === 'private_islands' ? 0.8 : 0.6,
                            smoothFactor: 1.0,
                            className: `flight-path-${groupName}`
                        }).addTo(map);
                        
                        // Create popup with flight details
                        const passengerList = flight.passengers.join(', ');
                        const suspiciousPassengers = flight.passengers.filter(p => 
                            p.includes('Female') || p.includes('minor') || /^\d+\s/.test(p)
                        );
                        
                        let popupContent = `
                            <strong>Flight ${flight.flightNo}</strong><br>
                            <strong>Date:</strong> ${formatDate(flight.date)}<br>
                            <strong>Route:</strong> ${createAirportTooltip(flight.from)} → ${createAirportTooltip(flight.to)}<br>
                            <strong>Passengers (${flight.passengers.length}):</strong><br>
                            ${passengerList}
                        `;
                        
                        if (suspiciousPassengers.length > 0) {
                            popupContent += `<br><strong style="color: red;">⚠️ Suspicious passengers detected</strong>`;
                        }
                        
                        polyline.bindPopup(popupContent);
                        
                        // Add to flight paths array
                        flightPaths.push(polyline);
                        
                        // Add arrow decorator to show direction
                        if (L.PolylineDecorator) {
                            const decorator = L.polylineDecorator(polyline, {
                                patterns: [{
                                    offset: '50%',
                                    repeat: 0,
                                    symbol: L.Symbol.arrowHead({
                                        pixelSize: 10,
                                        polygon: false,
                                        pathOptions: {
                                            stroke: true,
                                            weight: 2,
                                            color: color
                                        }
                                    })
                                }]
                            }).addTo(map);
                        }
                    }
                });
            });
            
            // Log statistics
            console.log('Flight path statistics:');
            Object.keys(routeGroups).forEach(group => {
                console.log(`${group}: ${routeGroups[group].length} flights`);
            });
            
            // Add legend to map
            addFlightLegend();
        }
        
        // Add legend for flight path colors
        function addFlightLegend() {
            const legend = L.control({ position: 'bottomleft' });
            
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'flight-legend');
                div.style.background = 'rgba(0,0,0,0.8)';
                div.style.padding = '10px';
                div.style.borderRadius = '5px';
                div.style.color = 'white';
                
                div.innerHTML = `
                    <h4 style="margin: 0 0 10px 0;">Flight Routes</h4>
                    <div><span style="background: #ff0000; width: 20px; height: 3px; display: inline-block;"></span> Virgin Islands (TIST)</div>
                    <div><span style="background: #ff6b6b; width: 20px; height: 3px; display: inline-block;"></span> Private Islands</div>
                    <div><span style="background: #ffa500; width: 20px; height: 3px; display: inline-block;"></span> Frequent Routes</div>
                    <div><span style="background: #800080; width: 20px; height: 3px; display: inline-block;"></span> International</div>
                    <div><span style="background: #4ecdc4; width: 20px; height: 3px; display: inline-block;"></span> Domestic</div>
                `;
                
                return div;
            };
            
            legend.addTo(map);
        }
        
        // Load KML data
        async function loadKMLData() {
            try {
                const response = await fetch('flightlogs_flightgraph.kml');
                const kmlText = await response.text();
                const parser = new DOMParser();
                const kmlDoc = parser.parseFromString(kmlText, 'text/xml');
                
                const placemarks = kmlDoc.querySelectorAll('Placemark');
                placemarks.forEach(placemark => {
                    const name = placemark.querySelector('name')?.textContent;
                    const description = placemark.querySelector('description')?.textContent;
                    const coordinates = placemark.querySelector('coordinates')?.textContent;
                    
                    if (coordinates) {
                        const coords = coordinates.trim().split(' ').map(coord => {
                            const [lng, lat] = coord.split(',').map(Number);
                            return [lat, lng];
                        });
                        
                        if (coords.length >= 2) {
                            const polyline = L.polyline(coords, {
                                color: '#ff6b6b',
                                weight: 2,
                                opacity: 0.6
                            }).addTo(map);
                            
                            polyline.bindPopup(`<strong>${name}</strong><br>${description || ''}`);
                            flightPaths.push(polyline);
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading KML data:', error);
            }
        }

        // Update statistics
        function updateStatistics() {
            document.getElementById('totalFlights').textContent = flightData.length;
            document.getElementById('uniquePassengers').textContent = Object.keys(passengerData).length;
            
            const frequentFlyers = Object.values(passengerData).filter(p => p.count >= 10).length;
            document.getElementById('frequentFlyers').textContent = frequentFlyers;
            
            const destinations = new Set(flightData.map(f => f.to));
            document.getElementById('destinations').textContent = destinations.size;
            
            const vipNames = ['Trump', 'Prince Andrew', 'Dershowitz', 'Larry Summers', 'Glenn Dubin', 'Alan Greenberg'];
            const vipFlights = flightData.filter(f => 
                f.passengers.some(p => vipNames.some(vip => p.toLowerCase().includes(vip.toLowerCase())))
            ).length;
            document.getElementById('vipFlights').textContent = vipFlights;
            
            // Detect suspicious patterns
            const suspicious = detectSuspiciousFlights();
            document.getElementById('suspiciousFlights').textContent = suspicious.length;
            
            // Add date range info
            if (flightData.length > 0) {
                const dates = flightData.map(f => f.date).filter(d => d).sort();
                const firstDate = formatDate(dates[0]);
                const lastDate = formatDate(dates[dates.length - 1]);
                console.log(`Flight data spans from ${firstDate} to ${lastDate}`);
                
                // Update page title to show date range
                const h1 = document.querySelector('h1');
                if (h1 && !h1.textContent.includes('(')) {
                    h1.innerHTML += `<br><span style="font-size: 0.6em; color: var(--secondary-color);">(${firstDate} to ${lastDate})</span>`;
                }
            }
        }

        // Detect suspicious flight patterns
        function detectSuspiciousFlights() {
            const suspicious = [];
            
            flightData.forEach(flight => {
                // Flag flights with young passengers
                const youngPassengers = ['minor', 'female', 'girl', 'young'];
                const hasYoung = flight.passengers.some(p => 
                    youngPassengers.some(term => p.toLowerCase().includes(term))
                );
                
                // Flag flights to private islands
                const privateDestinations = ['TIST', 'MBPV'];
                const isPrivate = privateDestinations.includes(flight.to);
                
                // Flag flights with only Epstein/Maxwell and unidentified passengers
                const hasUnidentified = flight.passengers.some(p => 
                    p.includes('Female') || p.includes('1 ') || p.includes('2 ')
                );
                
                if ((hasYoung || isPrivate) && hasUnidentified) {
                    suspicious.push(flight);
                }
            });
            
            return suspicious;
        }

        // Display flights in table
        function displayFlights(flights = flightData) {
            // Preserve scroll position
            const scrollY = window.scrollY;
            const scrollX = window.scrollX;
            
            const tbody = document.getElementById('flightsTableBody');
            tbody.innerHTML = '';
            
            flights.slice(0, 500).forEach(flight => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(flight.date)}</td>
                    <td>${flight.flightNo}</td>
                    <td>${createAirportTooltip(flight.from)}</td>
                    <td>${createAirportTooltip(flight.to)}</td>
                    <td>${formatPassengers(flight.passengers)}</td>
                    <td>${getFlightStatus(flight)}</td>
                `;
            });
            
            // Restore scroll position
            requestAnimationFrame(() => {
                window.scrollTo(scrollX, scrollY);
            });
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr || dateStr.length !== 8) return dateStr;
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${year}-${month}-${day}`;
        }

        // Create airport code with tooltip
        function createAirportTooltip(airportCode) {
            const airport = airports[airportCode];
            if (!airport) {
                return `<span class="airport-code">${airportCode}
                    <div class="airport-tooltip">
                        <div class="airport-name">Unknown Airport</div>
                        <div class="airport-location">Code: ${airportCode}</div>
                        <div class="airport-description">Airport information not available</div>
                    </div>
                </span>`;
            }

            return `<span class="airport-code">${airportCode}
                <div class="airport-tooltip">
                    <div class="airport-name">${airport.name}</div>
                    <div class="airport-location">${airport.location || 'Location not specified'}</div>
                    <div class="airport-description">${airport.description || airport.name}</div>
                </div>
            </span>`;
        }

        // Format passengers with hover tooltips
        function formatPassengers(passengers) {
            return passengers.map((p, index) => {
                let className = 'passenger-tag';
                const lowerP = p.toLowerCase();
                const trimmedP = p.trim();
                
                // Get identity info - create generic tooltip if none exists
                let identity = passengerIdentities[trimmedP];
                if (!identity) {
                    // Create generic tooltip for unknown passengers
                    if (lowerP.includes('epstein')) {
                        identity = 'Jeffrey Epstein - Convicted sex trafficker and financier';
                    } else if (lowerP.includes('maxwell')) {
                        identity = 'Ghislaine Maxwell - Convicted trafficker, daughter of Robert Maxwell';
                    } else if (lowerP.includes('female')) {
                        identity = 'Unidentified female passenger - Potential victim';
                    } else if (/^\d+\s/.test(p)) {
                        identity = 'Numbered passenger - Identity concealed, potential victim';
                    } else {
                        identity = `${trimmedP} - Limited information available`;
                    }
                }
                
                // All passengers get hover tooltips and click for bio cards
                className += ' hoverable-passenger bio-clickable';
                
                // Suspicious passengers (Epstein network core)
                if (lowerP.includes('epstein') || lowerP.includes('maxwell')) {
                    className += ' suspicious-tag';
                }
                
                // VIP passengers (high-profile individuals)
                if (lowerP.includes('trump') || lowerP.includes('dershowitz') || 
                    lowerP.includes('summers') || lowerP.includes('dubin') || 
                    lowerP.includes('greenberg') || lowerP.includes('prince andrew')) {
                    className += ' vip-tag';
                }
                
                // Unidentified passengers (potential victims)
                if (lowerP.includes('female') || /^\d+\s/.test(p) || 
                    lowerP.includes('girl') || lowerP.includes('minor')) {
                    className += ' suspicious-tag';
                }
                
                // Add hover tooltip with full identity and click for bio card
                const tooltip = identity.replace(/"/g, '&quot;');
                
                return `<span class="${className}" title="${tooltip}" data-passenger="${trimmedP}" onclick="showBioCard('${trimmedP}', event)">${p}</span>`;
            }).join(' ');
        }

        // Get flight status
        function getFlightStatus(flight) {
            const suspicious = detectSuspiciousFlights();
            if (suspicious.includes(flight)) {
                return '<span style="color: var(--danger-color);">🚨 Suspicious</span>';
            }
            return '<span style="color: var(--success-color);">✓ Logged</span>';
        }

        // Display all passengers (now uses sorting/filtering system)
        function displayPassengers() {
            const sortBy = document.getElementById('passengerSort') ? 
                document.getElementById('passengerSort').value : 'flights';
            const allPassengers = applySorting(Object.values(passengerData), sortBy);
            displayFilteredPassengers(allPassengers);
        }

        // Get initials for avatar
        function getInitials(name) {
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return parts[0][0] + parts[parts.length - 1][0];
            }
            return name.substring(0, 2).toUpperCase();
        }

        // Create charts
        function createCharts() {
            // Flights over time chart
            const timeCtx = document.getElementById('flightsTimeChart').getContext('2d');
            const flightsByYear = {};
            
            flightData.forEach(flight => {
                const year = flight.date.substring(0, 4);
                flightsByYear[year] = (flightsByYear[year] || 0) + 1;
            });
            
            new Chart(timeCtx, {
                type: 'line',
                data: {
                    labels: Object.keys(flightsByYear).sort(),
                    datasets: [{
                        label: 'Flights',
                        data: Object.keys(flightsByYear).sort().map(year => flightsByYear[year]),
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255,107,107,0.2)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0 // Disable animation to prevent scroll jumps
                    },
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#fff' }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#fff' }
                        }
                    }
                }
            });
            
            // Top destinations chart
            const destCtx = document.getElementById('destinationsChart').getContext('2d');
            const destinations = {};
            
            flightData.forEach(flight => {
                destinations[flight.to] = (destinations[flight.to] || 0) + 1;
            });
            
            const topDest = Object.entries(destinations)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            new Chart(destCtx, {
                type: 'bar',
                data: {
                    labels: topDest.map(d => d[0]),
                    datasets: [{
                        label: 'Flights',
                        data: topDest.map(d => d[1]),
                        backgroundColor: '#4ecdc4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const airportCode = tooltipItems[0].label;
                                    const airport = airports[airportCode];
                                    return airport ? airport.name : airportCode;
                                },
                                label: function(tooltipItem) {
                                    const airportCode = tooltipItem.label;
                                    const airport = airports[airportCode];
                                    const flightCount = tooltipItem.parsed.x;
                                    let result = [`Flights: ${flightCount}`];
                                    if (airport) {
                                        result.push(`Location: ${airport.location || 'Not specified'}`);
                                        if (airport.description) {
                                            result.push(`Info: ${airport.description}`);
                                        }
                                    }
                                    return result;
                                }
                            },
                            titleColor: '#4ecdc4',
                            bodyColor: '#ffffff',
                            backgroundColor: 'rgba(45, 45, 45, 0.9)',
                            borderColor: '#4ecdc4',
                            borderWidth: 2
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#fff' }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#fff' }
                        }
                    }
                }
            });
        }

        // Enhanced search with auto-complete (Advanced/Expert feature)
        function initializeAdvancedSearch() {
            const searchInput = document.getElementById('passengerSearch');
            if (!searchInput) return;
            
            // Add auto-complete functionality for advanced users
            if (currentUserMode === 'advanced' || currentUserMode === 'expert') {
                setupAutoComplete(searchInput);
            }
        }

        function setupAutoComplete(inputElement) {
            // Create auto-complete dropdown
            const dropdown = document.createElement('div');
            dropdown.className = 'autocomplete-dropdown';
            dropdown.style.cssText = `
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: var(--card-bg);
                border: 1px solid var(--accent-color);
                border-radius: 5px;
                max-height: 200px;
                overflow-y: auto;
                z-index: 1000;
                display: none;
            `;
            
            inputElement.parentElement.style.position = 'relative';
            inputElement.parentElement.appendChild(dropdown);
            
            inputElement.addEventListener('input', function(e) {
                const value = e.target.value.toLowerCase();
                if (value.length < 2) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                // Get matching passengers and search history
                const passengerMatches = Object.keys(passengerData)
                    .filter(name => name.toLowerCase().includes(value))
                    .slice(0, 8);
                    
                const historyMatches = searchHistory
                    .filter(term => term.toLowerCase().includes(value))
                    .slice(0, 5);
                
                const allMatches = [...new Set([...historyMatches, ...passengerMatches])];
                
                if (allMatches.length > 0) {
                    dropdown.innerHTML = allMatches
                        .map(match => `
                            <div class="autocomplete-item" style="
                                padding: 8px 12px;
                                cursor: pointer;
                                border-bottom: 1px solid rgba(255,255,255,0.1);
                                color: white;
                            " onclick="selectAutoComplete('${match}')">
                                ${match}
                            </div>
                        `).join('');
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!inputElement.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function selectAutoComplete(value) {
            const searchInput = document.getElementById('passengerSearch');
            searchInput.value = value;
            document.querySelector('.autocomplete-dropdown').style.display = 'none';
            saveSearchHistory(value);
            searchFlights();
        }

        // Network Analysis Dashboard (Expert Feature)
        function showNetworkAnalysis() {
            if (currentUserMode !== 'expert') {
                showNotification('Network Analysis requires Expert Mode', 'warning');
                return;
            }
            
            // Create or show network analysis modal
            showNetworkModal();
        }

        function showNetworkModal() {
            // Remove existing modal
            const existing = document.getElementById('networkModal');
            if (existing) existing.remove();
            
            // Create network analysis modal
            const modal = document.createElement('div');
            modal.id = 'networkModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--card-bg);
                    border: 2px solid var(--primary-color);
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 90vw;
                    max-height: 90vh;
                    overflow-y: auto;
                    width: 800px;
                    color: white;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2 style="color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 10px;">
                            🕸️ Network Analysis Dashboard
                        </h2>
                        <button onclick="closeNetworkModal()" style="
                            background: none;
                            border: none;
                            color: var(--primary-color);
                            font-size: 24px;
                            cursor: pointer;
                            padding: 0;
                            width: 30px;
                            height: 30px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">×</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; text-align: center;">
                            <h3 style="color: var(--accent-color); margin: 0 0 10px 0;">Network Density</h3>
                            <div style="font-size: 28px; font-weight: bold; color: var(--primary-color);">${calculateNetworkDensity().toFixed(2)}</div>
                            <div style="font-size: 12px; color: var(--secondary-color);">Connection ratio</div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; text-align: center;">
                            <h3 style="color: var(--accent-color); margin: 0 0 10px 0;">Key Nodes</h3>
                            <div style="font-size: 28px; font-weight: bold; color: var(--warning-color);">${getKeyNodes().length}</div>
                            <div style="font-size: 12px; color: var(--secondary-color);">High-influence passengers</div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; text-align: center;">
                            <h3 style="color: var(--accent-color); margin: 0 0 10px 0;">Communities</h3>
                            <div style="font-size: 28px; font-weight: bold; color: var(--success-color);">${detectCommunities().length}</div>
                            <div style="font-size: 12px; color: var(--secondary-color);">Passenger clusters</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 15px;">Top Network Connections</h3>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${generateNetworkConnections()}
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="exportNetworkData()" style="
                            background: var(--primary-color);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 25px;
                            cursor: pointer;
                            margin-right: 10px;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='var(--danger-color)'" onmouseout="this.style.background='var(--primary-color)'">
                            📥 Export Network Data
                        </button>
                        <button onclick="closeNetworkModal()" style="
                            background: var(--secondary-color);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 25px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        ">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeNetworkModal();
            });
        }

        function closeNetworkModal() {
            const modal = document.getElementById('networkModal');
            if (modal) modal.remove();
        }

        function calculateNetworkDensity() {
            // Calculate network density based on co-travel patterns
            const totalPassengers = Object.keys(passengerData).length;
            const totalConnections = Object.values(passengerData).reduce((sum, passenger) => {
                return sum + passenger.flights.length;
            }, 0);
            
            const maxPossibleConnections = (totalPassengers * (totalPassengers - 1)) / 2;
            return maxPossibleConnections > 0 ? (totalConnections / maxPossibleConnections) : 0;
        }

        function getKeyNodes() {
            // Identify passengers with high flight counts (key network nodes)
            return Object.values(passengerData)
                .filter(passenger => passenger.count >= 10)
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);
        }

        function detectCommunities() {
            // Simple community detection based on co-travel frequency
            const communities = [];
            const processed = new Set();
            
            Object.values(passengerData).forEach(passenger => {
                if (processed.has(passenger.name) || passenger.count < 5) return;
                
                const community = [passenger.name];
                processed.add(passenger.name);
                
                // Find passengers who frequently travel together
                passenger.flights.forEach(flight => {
                    flight.passengers.forEach(coTraveler => {
                        if (coTraveler !== passenger.name && !processed.has(coTraveler)) {
                            const coTravelerData = passengerData[coTraveler];
                            if (coTravelerData && coTravelerData.count >= 5) {
                                community.push(coTraveler);
                                processed.add(coTraveler);
                            }
                        }
                    });
                });
                
                if (community.length > 1) {
                    communities.push(community);
                }
            });
            
            return communities;
        }

        function generateNetworkConnections() {
            const connections = new Map();
            
            // Calculate co-travel frequencies
            flightData.forEach(flight => {
                if (flight.passengers.length < 2) return;
                
                for (let i = 0; i < flight.passengers.length; i++) {
                    for (let j = i + 1; j < flight.passengers.length; j++) {
                        const passenger1 = flight.passengers[i];
                        const passenger2 = flight.passengers[j];
                        const key = [passenger1, passenger2].sort().join(' <-> ');
                        
                        connections.set(key, (connections.get(key) || 0) + 1);
                    }
                }
            });
            
            // Sort by frequency and return top connections
            const sortedConnections = Array.from(connections.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);
            
            return sortedConnections.map(([connection, count]) => `
                <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 10px;
                    border-bottom: 1px solid rgba(255,255,255,0.1);
                    background: ${count > 5 ? 'rgba(255,107,107,0.1)' : 'transparent'};
                ">
                    <span style="font-size: 14px;">${connection}</span>
                    <span style="
                        background: ${count > 10 ? 'var(--danger-color)' : count > 5 ? 'var(--warning-color)' : 'var(--accent-color)'};
                        color: white;
                        padding: 4px 8px;
                        border-radius: 12px;
                        font-size: 12px;
                        font-weight: bold;
                    ">${count} flights</span>
                </div>
            `).join('');
        }

        function exportNetworkData() {
            const networkData = {
                density: calculateNetworkDensity(),
                keyNodes: getKeyNodes().map(node => ({
                    name: node.name,
                    flights: node.count,
                    influence: node.count / flightData.length
                })),
                communities: detectCommunities(),
                connections: Array.from(generateConnectionsMap().entries()).map(([connection, count]) => ({
                    connection,
                    frequency: count
                }))
            };
            
            const blob = new Blob([JSON.stringify(networkData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'epstein-network-analysis.json';
            a.click();
            
            showNotification('Network analysis data exported', 'success');
        }

        function generateConnectionsMap() {
            const connections = new Map();
            
            flightData.forEach(flight => {
                if (flight.passengers.length < 2) return;
                
                for (let i = 0; i < flight.passengers.length; i++) {
                    for (let j = i + 1; j < flight.passengers.length; j++) {
                        const passenger1 = flight.passengers[i];
                        const passenger2 = flight.passengers[j];
                        const key = [passenger1, passenger2].sort().join(' <-> ');
                        
                        connections.set(key, (connections.get(key) || 0) + 1);
                    }
                }
            });
            
            return connections;
        }

        // Statistical Analysis (Expert Feature)
        function showStatisticalAnalysis() {
            if (currentUserMode !== 'expert') {
                showNotification('Statistical Analysis requires Expert Mode', 'warning');
                return;
            }
            
            showStatisticalModal();
        }

        function showStatisticalModal() {
            const existing = document.getElementById('statisticalModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'statisticalModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow-y: auto;
            `;
            
            const stats = calculateAdvancedStatistics();
            
            modal.innerHTML = `
                <div style="
                    background: var(--card-bg);
                    border: 2px solid var(--primary-color);
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 95vw;
                    max-height: 95vh;
                    overflow-y: auto;
                    width: 900px;
                    color: white;
                    margin: 20px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2 style="color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 10px;">
                            📊 Statistical Analysis Dashboard
                        </h2>
                        <button onclick="closeStatisticalModal()" style="
                            background: none;
                            border: none;
                            color: var(--primary-color);
                            font-size: 24px;
                            cursor: pointer;
                            padding: 0;
                            width: 30px;
                            height: 30px;
                        ">×</button>
                    </div>
                    
                    <!-- Flight Frequency Analysis -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--accent-color); margin-bottom: 15px; border-bottom: 2px solid var(--accent-color); padding-bottom: 8px;">
                            📈 Flight Frequency Analysis
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; color: var(--primary-color); font-weight: bold;">${stats.avgFlightsPerPassenger.toFixed(1)}</div>
                                <div style="font-size: 12px; color: var(--secondary-color);">Avg Flights/Passenger</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; color: var(--warning-color); font-weight: bold;">${stats.peakFlightPeriod}</div>
                                <div style="font-size: 12px; color: var(--secondary-color);">Peak Activity Period</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; color: var(--success-color); font-weight: bold;">${stats.routeEfficiency.toFixed(2)}%</div>
                                <div style="font-size: 12px; color: var(--secondary-color);">Route Efficiency</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Co-travel Matrix -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--accent-color); margin-bottom: 15px; border-bottom: 2px solid var(--accent-color); padding-bottom: 8px;">
                            🔗 Co-Travel Matrix (Top Pairs)
                        </h3>
                        <div style="max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                            ${generateCoTravelMatrix()}
                        </div>
                    </div>
                    
                    <!-- Anomaly Detection -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--danger-color); margin-bottom: 15px; border-bottom: 2px solid var(--danger-color); padding-bottom: 8px;">
                            ⚠️ Anomaly Detection
                        </h3>
                        <div style="background: rgba(139,0,0,0.1); border: 1px solid var(--danger-color); border-radius: 8px; padding: 15px;">
                            ${generateAnomalyReport()}
                        </div>
                    </div>
                    
                    <!-- Pattern Recognition -->
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 15px; border-bottom: 2px solid var(--primary-color); padding-bottom: 8px;">
                            🔍 Pattern Recognition
                        </h3>
                        ${generatePatternAnalysis()}
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="exportStatisticalData()" style="
                            background: var(--primary-color);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 25px;
                            cursor: pointer;
                            margin-right: 10px;
                        ">📥 Export Statistical Report</button>
                        <button onclick="closeStatisticalModal()" style="
                            background: var(--secondary-color);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 25px;
                            cursor: pointer;
                        ">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeStatisticalModal();
            });
        }

        function closeStatisticalModal() {
            const modal = document.getElementById('statisticalModal');
            if (modal) modal.remove();
        }

        function calculateAdvancedStatistics() {
            const totalFlights = flightData.length;
            const totalPassengers = Object.keys(passengerData).length;
            
            // Calculate average flights per passenger
            const avgFlightsPerPassenger = totalPassengers > 0 ? totalFlights / totalPassengers : 0;
            
            // Find peak flight period
            const yearlyStats = {};
            flightData.forEach(flight => {
                const year = flight.date.substring(0, 4);
                yearlyStats[year] = (yearlyStats[year] || 0) + 1;
            });
            
            const peakYear = Object.entries(yearlyStats)
                .sort((a, b) => b[1] - a[1])[0];
            const peakFlightPeriod = peakYear ? peakYear[0] : 'N/A';
            
            // Calculate route efficiency (percentage of direct routes)
            const routes = flightData.map(f => `${f.from}-${f.to}`);
            const uniqueRoutes = new Set(routes);
            const routeEfficiency = routes.length > 0 ? (uniqueRoutes.size / routes.length) * 100 : 0;
            
            return {
                avgFlightsPerPassenger,
                peakFlightPeriod,
                routeEfficiency
            };
        }

        function generateCoTravelMatrix() {
            const coTravelMap = new Map();
            
            flightData.forEach(flight => {
                if (flight.passengers.length < 2) return;
                
                for (let i = 0; i < flight.passengers.length; i++) {
                    for (let j = i + 1; j < flight.passengers.length; j++) {
                        const pair = [flight.passengers[i], flight.passengers[j]].sort().join(' & ');
                        coTravelMap.set(pair, (coTravelMap.get(pair) || 0) + 1);
                    }
                }
            });
            
            return Array.from(coTravelMap.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20)
                .map(([pair, count]) => {
                    const riskLevel = count > 10 ? 'high' : count > 5 ? 'medium' : 'low';
                    const colors = {
                        high: 'var(--danger-color)',
                        medium: 'var(--warning-color)',
                        low: 'var(--success-color)'
                    };
                    
                    return `
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 8px 0;
                            border-bottom: 1px solid rgba(255,255,255,0.1);
                        ">
                            <span style="flex: 1; font-size: 13px;">${pair}</span>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 14px; font-weight: bold;">${count} flights</span>
                                <span style="
                                    background: ${colors[riskLevel]};
                                    color: white;
                                    padding: 2px 6px;
                                    border-radius: 10px;
                                    font-size: 10px;
                                    text-transform: uppercase;
                                ">${riskLevel} risk</span>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function generateAnomalyReport() {
            const anomalies = [];
            
            // Detect flights with unusual passenger patterns
            const suspiciousFlights = flightData.filter(flight => {
                const hasMinors = flight.passengers.some(p => 
                    p.toLowerCase().includes('female') || /^\d+/.test(p)
                );
                const hasEpsteinNetwork = flight.passengers.some(p => 
                    p.toLowerCase().includes('epstein') || p.toLowerCase().includes('maxwell')
                );
                const isPrivateDestination = ['TIST', 'MBPV'].includes(flight.to);
                
                return hasMinors && hasEpsteinNetwork && isPrivateDestination;
            });
            
            if (suspiciousFlights.length > 0) {
                anomalies.push(`🚨 ${suspiciousFlights.length} flights with concerning passenger combinations to private islands`);
            }
            
            // Detect passengers with unusually high flight frequency
            const highFrequencyPassengers = Object.values(passengerData)
                .filter(p => p.count > 20)
                .length;
            
            if (highFrequencyPassengers > 0) {
                anomalies.push(`⚠️ ${highFrequencyPassengers} passengers with unusually high flight frequency (>20 flights)`);
            }
            
            // Detect time-based anomalies
            const nightFlights = flightData.filter(flight => {
                // This is a simplified check - real implementation would need time data
                return flight.flightNo && flight.flightNo.includes('N');
            }).length;
            
            if (nightFlights > flightData.length * 0.3) {
                anomalies.push(`🌙 High percentage of potential night flights (${((nightFlights/flightData.length)*100).toFixed(1)}%)`);
            }
            
            return anomalies.length > 0 
                ? anomalies.map(anomaly => `<div style="margin-bottom: 8px;">${anomaly}</div>`).join('')
                : '<div style="color: var(--success-color);">No significant anomalies detected in current dataset</div>';
        }

        function generatePatternAnalysis() {
            const patterns = [];
            
            // Most common route pattern
            const routes = {};
            flightData.forEach(flight => {
                const route = `${flight.from} → ${flight.to}`;
                routes[route] = (routes[route] || 0) + 1;
            });
            
            const topRoute = Object.entries(routes)
                .sort((a, b) => b[1] - a[1])[0];
            
            if (topRoute) {
                patterns.push(`Most frequent route: <strong>${topRoute[0]}</strong> (${topRoute[1]} flights)`);
            }
            
            // Seasonal patterns (simplified)
            const monthlyFlights = {};
            flightData.forEach(flight => {
                if (flight.date.length >= 6) {
                    const month = flight.date.substring(4, 6);
                    monthlyFlights[month] = (monthlyFlights[month] || 0) + 1;
                }
            });
            
            const peakMonth = Object.entries(monthlyFlights)
                .sort((a, b) => b[1] - a[1])[0];
            
            if (peakMonth) {
                const monthNames = {
                    '01': 'January', '02': 'February', '03': 'March', '04': 'April',
                    '05': 'May', '06': 'June', '07': 'July', '08': 'August',
                    '09': 'September', '10': 'October', '11': 'November', '12': 'December'
                };
                patterns.push(`Peak activity month: <strong>${monthNames[peakMonth[0]] || peakMonth[0]}</strong> (${peakMonth[1]} flights)`);
            }
            
            return patterns.length > 0 
                ? patterns.map(pattern => `<div style="margin-bottom: 12px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">${pattern}</div>`).join('')
                : '<div>No clear patterns detected</div>';
        }

        function exportStatisticalData() {
            const stats = calculateAdvancedStatistics();
            const report = {
                generatedAt: new Date().toISOString(),
                summary: {
                    totalFlights: flightData.length,
                    totalPassengers: Object.keys(passengerData).length,
                    avgFlightsPerPassenger: stats.avgFlightsPerPassenger,
                    peakFlightPeriod: stats.peakFlightPeriod,
                    routeEfficiency: stats.routeEfficiency
                },
                coTravelAnalysis: Array.from(generateConnectionsMap().entries())
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 50)
                    .map(([pair, count]) => ({ pair, frequency: count })),
                anomalies: {
                    suspiciousFlights: flightData.filter(flight => {
                        const hasMinors = flight.passengers.some(p => 
                            p.toLowerCase().includes('female') || /^\d+/.test(p)
                        );
                        const hasEpsteinNetwork = flight.passengers.some(p => 
                            p.toLowerCase().includes('epstein') || p.toLowerCase().includes('maxwell')
                        );
                        const isPrivateDestination = ['TIST', 'MBPV'].includes(flight.to);
                        return hasMinors && hasEpsteinNetwork && isPrivateDestination;
                    }).length,
                    highFrequencyPassengers: Object.values(passengerData).filter(p => p.count > 20).length
                }
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'epstein-statistical-analysis.json';
            a.click();
            
            showNotification('Statistical analysis exported', 'success');
        }

        // Evidence Classification System
        function initializeEvidenceClassification() {
            // Classify flight log data based on source reliability
            classifyFlightLogData();
            
            // Initialize confidence indicators in UI
            addConfidenceIndicators();
        }

        function classifyFlightLogData() {
            // Default classification for flight log data
            flightData.forEach((flight, index) => {
                let reliability = 'probable'; // Default for official flight logs
                let confidence = 0.8;
                
                // Increase confidence for flights with multiple corroborating sources
                if (flight.passengers.some(p => 
                    ['Jeffrey Epstein', 'Ghislaine Maxwell', 'Larry Visoski'].includes(p)
                )) {
                    reliability = 'verified';
                    confidence = 1.0;
                }
                
                // Lower confidence for flights with unidentified passengers
                if (flight.passengers.some(p => 
                    p.includes('Female') || /^\d+/.test(p) || p.includes('Unidentified')
                )) {
                    reliability = 'unverified';
                    confidence = 0.6;
                }
                
                // Mark disputed flights (if any contradictory evidence exists)
                if (flight.passengers.some(p => p.includes('Disputed'))) {
                    reliability = 'disputed';
                    confidence = 0.3;
                }
                
                dataSourceClassification[`flight_${index}`] = {
                    reliability,
                    confidence,
                    source: 'FAA Flight Logs',
                    verificationDate: '2019-08-10', // Epstein's arrest date
                    notes: getReliabilityNotes(reliability)
                };
            });
        }

        function getReliabilityNotes(reliability) {
            const notes = {
                'verified': 'Corroborated by multiple sources including court documents and pilot testimony',
                'probable': 'Based on official flight logs with consistent documentation patterns',
                'unverified': 'Contains unidentified passengers or incomplete passenger manifests',
                'disputed': 'Conflicting information exists or source reliability questioned'
            };
            return notes[reliability] || 'No additional notes available';
        }

        function addConfidenceIndicators() {
            // Add confidence indicators to flight table rows
            setTimeout(() => {
                const rows = document.querySelectorAll('#flightsTableBody tr');
                rows.forEach((row, index) => {
                    const classification = dataSourceClassification[`flight_${index}`];
                    if (classification) {
                        addReliabilityIndicator(row, classification);
                    }
                });
            }, 1000);
        }

        function addReliabilityIndicator(row, classification) {
            const indicator = document.createElement('div');
            indicator.className = 'reliability-indicator';
            
            const colorMap = {
                'verified': 'var(--success-color)',
                'probable': 'var(--accent-color)',
                'unverified': 'var(--warning-color)',
                'disputed': 'var(--danger-color)'
            };
            
            const iconMap = {
                'verified': '✓',
                'probable': '✓␣',
                'unverified': '?',
                'disputed': '⚠'
            };
            
            indicator.style.cssText = `
                position: absolute;
                top: 2px;
                right: 2px;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: ${colorMap[classification.reliability]};
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                font-weight: bold;
                cursor: help;
                z-index: 5;
            `;
            
            indicator.textContent = iconMap[classification.reliability];
            indicator.title = `Reliability: ${classification.reliability.toUpperCase()}\nConfidence: ${(classification.confidence * 100).toFixed(0)}%\nSource: ${classification.source}\nNotes: ${classification.notes}`;
            
            // Make row position relative to contain absolute indicator
            if (!row.style.position) {
                row.style.position = 'relative';
            }
            
            row.appendChild(indicator);
        }

        function showEvidenceClassificationPanel() {
            const existing = document.getElementById('evidencePanel');
            if (existing) existing.remove();
            
            const panel = document.createElement('div');
            panel.id = 'evidencePanel';
            panel.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const reliabilityStats = calculateReliabilityStatistics();
            
            panel.innerHTML = `
                <div style="
                    background: var(--card-bg);
                    border: 2px solid var(--primary-color);
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 90vw;
                    max-height: 90vh;
                    overflow-y: auto;
                    width: 700px;
                    color: white;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2 style="color: var(--primary-color); margin: 0;">
                            🏆 Evidence Classification System
                        </h2>
                        <button onclick="closeEvidencePanel()" style="
                            background: none;
                            border: none;
                            color: var(--primary-color);
                            font-size: 24px;
                            cursor: pointer;
                        ">×</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: var(--success-color); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${reliabilityStats.verified}</div>
                            <div style="font-size: 12px;">VERIFIED</div>
                            <div style="font-size: 10px; margin-top: 5px;">Court documents, testimony</div>
                        </div>
                        <div style="background: var(--accent-color); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${reliabilityStats.probable}</div>
                            <div style="font-size: 12px;">PROBABLE</div>
                            <div style="font-size: 10px; margin-top: 5px;">Official flight logs</div>
                        </div>
                        <div style="background: var(--warning-color); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${reliabilityStats.unverified}</div>
                            <div style="font-size: 12px;">UNVERIFIED</div>
                            <div style="font-size: 10px; margin-top: 5px;">Incomplete records</div>
                        </div>
                        <div style="background: var(--danger-color); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${reliabilityStats.disputed}</div>
                            <div style="font-size: 12px;">DISPUTED</div>
                            <div style="font-size: 10px; margin-top: 5px;">Conflicting evidence</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent-color); margin-bottom: 15px;">Reliability Criteria</h3>
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                            <div style="margin-bottom: 10px;"><strong style="color: var(--success-color);">✓ VERIFIED:</strong> Multiple corroborating sources, court documents, sworn testimony</div>
                            <div style="margin-bottom: 10px;"><strong style="color: var(--accent-color);">✓␣ PROBABLE:</strong> Official records with consistent documentation patterns</div>
                            <div style="margin-bottom: 10px;"><strong style="color: var(--warning-color);">? UNVERIFIED:</strong> Single source, unidentified passengers, incomplete manifests</div>
                            <div><strong style="color: var(--danger-color);">⚠ DISPUTED:</strong> Contradictory information or questioned source reliability</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 15px;">Confidence Scoring</h3>
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                            <div style="margin-bottom: 8px;">High Confidence (80-100%): ${reliabilityStats.highConfidence} records</div>
                            <div style="margin-bottom: 8px;">Medium Confidence (60-79%): ${reliabilityStats.mediumConfidence} records</div>
                            <div>Low Confidence (40-59%): ${reliabilityStats.lowConfidence} records</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="toggleReliabilityFilter()" style="
                            background: var(--primary-color);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 25px;
                            cursor: pointer;
                            margin-right: 10px;
                        ">Filter by High Confidence</button>
                        <button onclick="exportEvidenceReport()" style="
                            background: var(--secondary-color);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 25px;
                            cursor: pointer;
                            margin-right: 10px;
                        ">Export Evidence Report</button>
                        <button onclick="closeEvidencePanel()" style="
                            background: var(--accent-color);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 25px;
                            cursor: pointer;
                        ">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(panel);
            panel.addEventListener('click', function(e) {
                if (e.target === panel) closeEvidencePanel();
            });
        }

        function closeEvidencePanel() {
            const panel = document.getElementById('evidencePanel');
            if (panel) panel.remove();
        }

        function calculateReliabilityStatistics() {
            let verified = 0, probable = 0, unverified = 0, disputed = 0;
            let highConfidence = 0, mediumConfidence = 0, lowConfidence = 0;
            
            Object.values(dataSourceClassification).forEach(classification => {
                switch (classification.reliability) {
                    case 'verified': verified++; break;
                    case 'probable': probable++; break;
                    case 'unverified': unverified++; break;
                    case 'disputed': disputed++; break;
                }
                
                if (classification.confidence >= confidenceThresholds.high) {
                    highConfidence++;
                } else if (classification.confidence >= confidenceThresholds.medium) {
                    mediumConfidence++;
                } else {
                    lowConfidence++;
                }
            });
            
            return { verified, probable, unverified, disputed, highConfidence, mediumConfidence, lowConfidence };
        }

        function toggleReliabilityFilter() {
            // Filter flights by high confidence only
            const highConfidenceFlights = flightData.filter((flight, index) => {
                const classification = dataSourceClassification[`flight_${index}`];
                return classification && classification.confidence >= confidenceThresholds.high;
            });
            
            displayFlights(highConfidenceFlights);
            showNotification(`Showing ${highConfidenceFlights.length} high-confidence flights`, 'success');
            closeEvidencePanel();
        }

        function exportEvidenceReport() {
            const report = {
                generatedAt: new Date().toISOString(),
                methodology: {
                    reliabilityScales: evidenceReliabilityScores,
                    confidenceThresholds: confidenceThresholds,
                    classification: 'Based on source documentation and corroboration level'
                },
                statistics: calculateReliabilityStatistics(),
                dataClassification: Object.entries(dataSourceClassification).map(([key, classification]) => ({
                    recordId: key,
                    reliability: classification.reliability,
                    confidence: classification.confidence,
                    source: classification.source,
                    notes: classification.notes
                }))
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'epstein-evidence-classification.json';
            a.click();
            
            showNotification('Evidence classification report exported', 'success');
        }

        // Brushing and Linking System Implementation
        function toggleBrushingMode() {
            brushingEnabled = !brushingEnabled;
            const toggle = document.getElementById('brushingToggle');
            
            if (brushingEnabled) {
                toggle.textContent = '🔗 Linked Mode';
                toggle.style.background = 'var(--success-color)';
                enableBrushingInteractions();
                showNotification('Brushing & Linking Mode Activated', 'success');
            } else {
                toggle.textContent = '🎨 Brushing Mode';
                toggle.style.background = 'var(--primary-color)';
                disableBrushingInteractions();
                clearAllSelections();
                showNotification('Brushing Mode Deactivated', 'info');
            }
        }

        function enableBrushingInteractions() {
            // Add selection indicators to UI elements
            document.body.classList.add('brushing-enabled');
            
            // Enhanced passenger card interactions
            enhancePassengerCardInteractions();
            
            // Enhanced map interactions
            enhanceMapInteractions();
        }

        function disableBrushingInteractions() {
            document.body.classList.remove('brushing-enabled');
        }

        function enhancePassengerCardInteractions() {
            // Add multi-select capability to passenger cards
            const passengerCards = document.querySelectorAll('.passenger-card');
            passengerCards.forEach(card => {
                const originalOnClick = card.onclick;
                card.onclick = function(e) {
                    if (!brushingEnabled) {
                        if (originalOnClick) originalOnClick.call(this, e);
                        return;
                    }
                    
                    e.preventDefault();
                    const passengerName = this.querySelector('.passenger-name').textContent;
                    
                    // Toggle selection with Ctrl/Cmd key support
                    if (e.ctrlKey || e.metaKey) {
                        togglePassengerSelection(passengerName, true);
                    } else {
                        togglePassengerSelection(passengerName, false);
                    }
                    
                    // Update linked views
                    updateLinkedViews();
                };
            });
        }

        function enhanceMapInteractions() {
            // Enhanced map interactions will be added in future updates
            console.log('Enhanced map interactions enabled');
        }

        function togglePassengerSelection(passengerName, multiSelect = false) {
            if (!multiSelect) {
                selectedPassengers.clear();
                document.querySelectorAll('.passenger-card.selected').forEach(card => {
                    card.classList.remove('selected');
                });
            }
            
            if (selectedPassengers.has(passengerName)) {
                selectedPassengers.delete(passengerName);
                const card = findPassengerCard(passengerName);
                if (card) card.classList.remove('selected');
            } else {
                selectedPassengers.add(passengerName);
                const card = findPassengerCard(passengerName);
                if (card) card.classList.add('selected');
            }
            
            linkedSelections.passengers = new Set(selectedPassengers);
            saveSelectionState();
            showNotification(`Selected ${selectedPassengers.size} passenger(s)`, 'info');
        }

        function updateLinkedViews() {
            if (!brushingEnabled) return;
            
            updateFlightTableWithSelections();
            updateMapWithSelections();
            updatePassengerGridWithSelections();
            updateStatisticsWithSelections();
        }

        function updateFlightTableWithSelections() {
            if (selectedPassengers.size === 0) {
                displayFlights();
                return;
            }
            
            const filteredFlights = flightData.filter(flight => 
                flight.passengers.some(passenger => 
                    selectedPassengers.has(passenger)
                )
            );
            
            displayFlights(filteredFlights);
            setTimeout(() => highlightSelectedFlights(), 100);
        }

        function updateMapWithSelections() {
            if (!map) return;
            
            flightPaths.forEach(path => {
                const opacity = selectedPassengers.size > 0 ? 0.3 : 0.6;
                path.setStyle({ opacity, weight: 2 });
            });
        }

        function updatePassengerGridWithSelections() {
            const cards = document.querySelectorAll('.passenger-card');
            cards.forEach(card => {
                const passengerName = card.querySelector('.passenger-name').textContent;
                
                if (selectedPassengers.has(passengerName)) {
                    card.classList.add('selected');
                    card.classList.remove('dimmed');
                } else if (selectedPassengers.size > 0) {
                    card.classList.add('dimmed');
                    card.classList.remove('selected');
                } else {
                    card.classList.remove('dimmed', 'selected');
                }
            });
        }

        function updateStatisticsWithSelections() {
            if (selectedPassengers.size === 0) {
                updateStatistics();
                return;
            }
            
            const selectedFlights = flightData.filter(flight => 
                flight.passengers.some(passenger => 
                    selectedPassengers.has(passenger)
                )
            );
            
            document.getElementById('totalFlights').textContent = selectedFlights.length;
            document.getElementById('uniquePassengers').textContent = selectedPassengers.size;
            
            const selectedDestinations = new Set(selectedFlights.map(f => f.to));
            document.getElementById('destinations').textContent = selectedDestinations.size;
        }

        function findPassengerCard(passengerName) {
            const cards = document.querySelectorAll('.passenger-card');
            return Array.from(cards).find(card => 
                card.querySelector('.passenger-name').textContent === passengerName
            );
        }

        function highlightSelectedFlights() {
            const rows = document.querySelectorAll('#flightsTableBody tr');
            rows.forEach(row => {
                const hasSelectedPassenger = Array.from(row.querySelectorAll('.passenger-tag'))
                    .some(tag => selectedPassengers.has(tag.textContent.trim()));
                
                if (hasSelectedPassenger) {
                    row.classList.add('highlighted-row');
                } else {
                    row.classList.remove('highlighted-row');
                }
            });
        }

        function saveSelectionState() {
            const state = {
                timestamp: Date.now(),
                passengers: Array.from(selectedPassengers)
            };
            
            selectionHistory.push(state);
            if (selectionHistory.length > 20) {
                selectionHistory = selectionHistory.slice(-20);
            }
        }

        function clearAllSelections() {
            selectedPassengers.clear();
            selectedRoutes.clear();
            selectedDateRange = null;
            
            document.querySelectorAll('.selected, .dimmed, .highlighted-row').forEach(element => {
                element.classList.remove('selected', 'dimmed', 'highlighted-row');
            });
            
            displayFlights();
            displayPassengers();
            updateStatistics();
            
            if (map && flightPaths.length > 0) {
                flightPaths.forEach(path => {
                    path.setStyle({ opacity: 0.6, weight: 2 });
                });
            }
            
            showNotification('All selections cleared', 'info');
        }

        // Enhanced search flights with history tracking
        function searchFlights() {
            const passengerSearch = document.getElementById('passengerSearch').value.toLowerCase();
            
            // Save search term to history
            if (passengerSearch) {
                saveSearchHistory(passengerSearch);
            }
            
            const startDate = document.getElementById('startDate').value.replace(/-/g, '');
            const endDate = document.getElementById('endDate').value.replace(/-/g, '');
            const destination = document.getElementById('destinationFilter').value;
            
            let filtered = flightData;
            
            if (passengerSearch) {
                filtered = filtered.filter(f => 
                    f.passengers.some(p => p.toLowerCase().includes(passengerSearch))
                );
            }
            
            if (startDate) {
                filtered = filtered.filter(f => f.date >= startDate);
            }
            
            if (endDate) {
                filtered = filtered.filter(f => f.date <= endDate);
            }
            
            if (destination) {
                filtered = filtered.filter(f => f.to === destination);
            }
            
            displayFlights(filtered);
            showNotification(`Found ${filtered.length} flights`, 'success');
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('passengerSearch').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('destinationFilter').value = '';
            displayFlights();
            showNotification('Filters reset', 'info');
        }

        // Show suspicious flights only
        function showSuspiciousOnly() {
            const suspicious = detectSuspiciousFlights();
            displayFlights(suspicious);
            showNotification(`Showing ${suspicious.length} suspicious flights`, 'warning');
        }

        // Filter by passenger
        function filterByPassenger(name) {
            document.getElementById('passengerSearch').value = name;
            searchFlights();
        }

        // Search passengers by name
        function searchPassengers() {
            const searchTerm = document.getElementById('passengerNameSearch').value.toLowerCase();
            const sortBy = document.getElementById('passengerSort').value;
            
            let filteredPassengers = Object.values(passengerData);
            
            // Filter by search term
            if (searchTerm) {
                filteredPassengers = filteredPassengers.filter(passenger => 
                    passenger.name.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply sorting
            filteredPassengers = applySorting(filteredPassengers, sortBy);
            
            displayFilteredPassengers(filteredPassengers);
        }

        // Sort passengers
        function sortPassengers() {
            const searchTerm = document.getElementById('passengerNameSearch').value.toLowerCase();
            const sortBy = document.getElementById('passengerSort').value;
            
            let filteredPassengers = Object.values(passengerData);
            
            // Filter by search term
            if (searchTerm) {
                filteredPassengers = filteredPassengers.filter(passenger => 
                    passenger.name.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply sorting
            filteredPassengers = applySorting(filteredPassengers, sortBy);
            
            displayFilteredPassengers(filteredPassengers);
        }

        // Apply sorting logic
        function applySorting(passengers, sortBy) {
            switch (sortBy) {
                case 'name':
                    return passengers.sort((a, b) => a.name.localeCompare(b.name));
                case 'name-desc':
                    return passengers.sort((a, b) => b.name.localeCompare(a.name));
                case 'flights':
                default:
                    return passengers.sort((a, b) => b.count - a.count);
            }
        }

        // Display filtered and sorted passengers
        function displayFilteredPassengers(passengers) {
            // Preserve scroll position
            const scrollY = window.scrollY;
            const scrollX = window.scrollX;
            
            const passengerGrid = document.getElementById('passengerGrid');
            passengerGrid.innerHTML = '';
            
            passengers.forEach(passenger => {
                const card = document.createElement('div');
                card.className = 'passenger-card';
                card.innerHTML = `
                    <div class="selection-indicator"></div>
                    <div class="passenger-photo">${getInitials(passenger.name)}</div>
                    <div class="passenger-name">${passenger.name}</div>
                    <div class="passenger-stats">
                        <span class="flight-count">${passenger.count} flights</span>
                    </div>
                `;
                card.onclick = () => showBioCard(passenger.name, event);
                passengerGrid.appendChild(card);
            });
            
            // Restore scroll position
            requestAnimationFrame(() => {
                window.scrollTo(scrollX, scrollY);
            });
            
            // Show count
            const resultCount = passengers.length;
            const totalCount = Object.keys(passengerData).length;
            showNotification(`Showing ${resultCount} of ${totalCount} passengers`, 'info');
        }

        // Animate flight paths
        function animateFlights() {
            if (currentAnimation) {
                clearInterval(currentAnimation);
                currentAnimation = null;
                showNotification('Animation stopped', 'info');
                return;
            }
            
            let index = 0;
            currentAnimation = setInterval(() => {
                if (index >= flightPaths.length) {
                    clearInterval(currentAnimation);
                    currentAnimation = null;
                    showNotification('Animation complete', 'success');
                    return;
                }
                
                flightPaths[index].setStyle({ opacity: 1, weight: 4 });
                setTimeout(() => {
                    flightPaths[index].setStyle({ opacity: 0.6, weight: 2 });
                }, 500);
                
                index++;
            }, 200);
            
            showNotification('Animating flight paths...', 'info');
        }

        // Enhanced Export and Sharing System
        function exportData() {
            showExportModal();
        }

        function showExportModal() {
            const existing = document.getElementById('exportModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'exportModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--card-bg);
                    border: 2px solid var(--primary-color);
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 90vw;
                    width: 600px;
                    color: white;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2 style="color: var(--primary-color); margin: 0;">
                            📥 Export & Share Data
                        </h2>
                        <button onclick="closeExportModal()" style="
                            background: none;
                            border: none;
                            color: var(--primary-color);
                            font-size: 24px;
                            cursor: pointer;
                        ">×</button>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: var(--accent-color); margin-bottom: 15px;">Export Formats</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                            <button onclick="exportAsCSV()" style="
                                background: var(--success-color);
                                color: white;
                                border: none;
                                padding: 15px;
                                border-radius: 10px;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                gap: 8px;
                            " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <div style="font-size: 24px;">📄</div>
                                <div style="font-weight: bold;">CSV</div>
                                <div style="font-size: 12px; opacity: 0.9;">Spreadsheet format</div>
                            </button>
                            
                            <button onclick="exportAsJSON()" style="
                                background: var(--accent-color);
                                color: white;
                                border: none;
                                padding: 15px;
                                border-radius: 10px;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                gap: 8px;
                            " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <div style="font-size: 24px;">📝</div>
                                <div style="font-weight: bold;">JSON</div>
                                <div style="font-size: 12px; opacity: 0.9;">Structured data</div>
                            </button>
                            
                            <button onclick="exportAsPDF()" style="
                                background: var(--danger-color);
                                color: white;
                                border: none;
                                padding: 15px;
                                border-radius: 10px;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                gap: 8px;
                            " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <div style="font-size: 24px;">📜</div>
                                <div style="font-weight: bold;">PDF</div>
                                <div style="font-size: 12px; opacity: 0.9;">Report format</div>
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: var(--accent-color); margin-bottom: 15px;">Share Current View</h3>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                            <input type="text" id="shareUrl" readonly style="
                                flex: 1;
                                padding: 12px;
                                background: rgba(255,255,255,0.1);
                                border: 1px solid rgba(255,255,255,0.2);
                                border-radius: 5px;
                                color: white;
                                font-size: 14px;
                            " value="${generateShareUrl()}">
                            <button onclick="copyShareUrl()" style="
                                background: var(--primary-color);
                                color: white;
                                border: none;
                                padding: 12px 16px;
                                border-radius: 5px;
                                cursor: pointer;
                                min-width: 80px;
                            ">Copy Link</button>
                        </div>
                        <div style="font-size: 13px; color: var(--secondary-color); margin-bottom: 15px;">
                            This link preserves your current filters, selections, and view settings
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: var(--accent-color); margin-bottom: 15px;">Quick Actions</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="exportSelectedData()" style="
                                background: var(--warning-color);
                                color: black;
                                border: none;
                                padding: 10px 16px;
                                border-radius: 20px;
                                cursor: pointer;
                                font-size: 14px;
                            ">Export Selected Only</button>
                            <button onclick="exportWithReliability()" style="
                                background: var(--secondary-color);
                                color: white;
                                border: none;
                                padding: 10px 16px;
                                border-radius: 20px;
                                cursor: pointer;
                                font-size: 14px;
                            ">Include Reliability Data</button>
                            <button onclick="exportSummaryReport()" style="
                                background: var(--accent-color);
                                color: white;
                                border: none;
                                padding: 10px 16px;
                                border-radius: 20px;
                                cursor: pointer;
                                font-size: 14px;
                            ">Generate Summary Report</button>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="closeExportModal()" style="
                            background: var(--secondary-color);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 25px;
                            cursor: pointer;
                        ">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeExportModal();
            });
        }

        function closeExportModal() {
            const modal = document.getElementById('exportModal');
            if (modal) modal.remove();
        }

        function exportAsCSV() {
            const data = flightData.map(f => ({
                date: formatDate(f.date),
                flight: f.flightNo,
                from: f.from,
                to: f.to,
                passengers: f.passengers.join(', '),
                passenger_count: f.passengers.length
            }));
            
            const csv = [
                Object.keys(data[0]).join(','),
                ...data.map(row => Object.values(row).map(v => `"${v}"`).join(','))
            ].join('\n');
            
            downloadFile(csv, 'epstein-flights-export.csv', 'text/csv');
            showNotification('CSV data exported successfully', 'success');
            closeExportModal();
        }

        function exportAsJSON() {
            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    totalFlights: flightData.length,
                    totalPassengers: Object.keys(passengerData).length,
                    dateRange: {
                        start: flightData[0]?.date,
                        end: flightData[flightData.length - 1]?.date
                    }
                },
                flights: flightData.map((f, index) => ({
                    id: index,
                    date: formatDate(f.date),
                    flightNumber: f.flightNo,
                    departure: f.from,
                    destination: f.to,
                    passengers: f.passengers,
                    passengerCount: f.passengers.length,
                    reliability: dataSourceClassification[`flight_${index}`]
                })),
                passengers: Object.entries(passengerData).map(([name, data]) => ({
                    name: name,
                    flightCount: data.count,
                    identity: passengerIdentities[name] || 'Identity not specified'
                }))
            };
            
            const json = JSON.stringify(exportData, null, 2);
            downloadFile(json, 'epstein-flights-complete.json', 'application/json');
            showNotification('JSON data exported successfully', 'success');
            closeExportModal();
        }

        function exportAsPDF() {
            // Create a comprehensive HTML report for PDF conversion
            const reportHtml = generatePDFReport();
            
            // For now, create a printable HTML version
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportHtml);
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
            }, 1000);
            
            showNotification('PDF report opened for printing', 'info');
            closeExportModal();
        }

        function generatePDFReport() {
            const stats = calculateAdvancedStatistics();
            const reliabilityStats = calculateReliabilityStatistics();
            const topPassengers = Object.values(passengerData)
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Epstein Flight Logs Analysis Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                        .header { text-align: center; margin-bottom: 40px; border-bottom: 3px solid #333; padding-bottom: 20px; }
                        .section { margin-bottom: 30px; }
                        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
                        .stat-box { border: 1px solid #ccc; padding: 15px; text-align: center; }
                        .stat-number { font-size: 2em; font-weight: bold; color: #333; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .reliability-high { background-color: #d4edda; }
                        .reliability-medium { background-color: #fff3cd; }
                        .reliability-low { background-color: #f8d7da; }
                        @media print { 
                            body { margin: 20px; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Epstein Flight Logs Analysis Report</h1>
                        <p>Generated: ${new Date().toLocaleString()}</p>
                        <p>Comprehensive analysis of Jeffrey Epstein's flight records</p>
                    </div>
                    
                    <div class="section">
                        <h2>Executive Summary</h2>
                        <div class="stat-grid">
                            <div class="stat-box">
                                <div class="stat-number">${flightData.length}</div>
                                <div>Total Flights</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number">${Object.keys(passengerData).length}</div>
                                <div>Unique Passengers</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number">${stats.avgFlightsPerPassenger.toFixed(1)}</div>
                                <div>Avg Flights/Passenger</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>Top Passengers by Flight Count</h2>
                        <table>
                            <thead>
                                <tr><th>Passenger</th><th>Flight Count</th><th>Identity</th></tr>
                            </thead>
                            <tbody>
                                ${topPassengers.map(p => `
                                    <tr>
                                        <td>${p.name}</td>
                                        <td>${p.count}</td>
                                        <td>${passengerIdentities[p.name] || 'Not specified'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="section">
                        <h2>Data Reliability Assessment</h2>
                        <div class="stat-grid">
                            <div class="stat-box reliability-high">
                                <div class="stat-number">${reliabilityStats.verified + reliabilityStats.probable}</div>
                                <div>High Reliability Records</div>
                            </div>
                            <div class="stat-box reliability-medium">
                                <div class="stat-number">${reliabilityStats.unverified}</div>
                                <div>Medium Reliability Records</div>
                            </div>
                            <div class="stat-box reliability-low">
                                <div class="stat-number">${reliabilityStats.disputed}</div>
                                <div>Low Reliability Records</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <p><strong>Note:</strong> This report is generated for investigative and educational purposes based on publicly available flight log data. All passenger identities and associations are based on court documents, media reports, and publicly available information.</p>
                    </div>
                    
                    <button class="no-print" onclick="window.close()" style="margin: 20px 0; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Close Report</button>
                </body>
                </html>
            `;
        }

        function generateShareUrl() {
            const params = new URLSearchParams();
            
            // Add current user mode
            params.set('mode', currentUserMode);
            
            // Add current filters
            const passengerSearch = document.getElementById('passengerSearch')?.value;
            if (passengerSearch) params.set('passenger', passengerSearch);
            
            const startDate = document.getElementById('startDate')?.value;
            if (startDate) params.set('start', startDate);
            
            const endDate = document.getElementById('endDate')?.value;
            if (endDate) params.set('end', endDate);
            
            const destination = document.getElementById('destinationFilter')?.value;
            if (destination) params.set('dest', destination);
            
            // Add current selections if brushing is enabled
            if (brushingEnabled && selectedPassengers.size > 0) {
                params.set('selected', Array.from(selectedPassengers).join(','));
            }
            
            // Add map layer and overlay settings
            params.set('mapLayer', currentMapLayer);
            params.set('overlay', currentOverlay);
            
            return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
        }

        function copyShareUrl() {
            const urlInput = document.getElementById('shareUrl');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showNotification('Share URL copied to clipboard', 'success');
            } catch (err) {
                // Fallback for newer browsers
                navigator.clipboard.writeText(urlInput.value).then(() => {
                    showNotification('Share URL copied to clipboard', 'success');
                }).catch(() => {
                    showNotification('Failed to copy URL. Please copy manually.', 'warning');
                });
            }
        }

        function exportSelectedData() {
            if (selectedPassengers.size === 0) {
                showNotification('No passengers selected for export', 'warning');
                return;
            }
            
            const selectedFlights = flightData.filter(flight => 
                flight.passengers.some(passenger => 
                    selectedPassengers.has(passenger)
                )
            );
            
            const data = selectedFlights.map(f => ({
                date: formatDate(f.date),
                flight: f.flightNo,
                from: f.from,
                to: f.to,
                passengers: f.passengers.join(', ')
            }));
            
            const csv = [
                Object.keys(data[0]).join(','),
                ...data.map(row => Object.values(row).map(v => `"${v}"`).join(','))
            ].join('\n');
            
            downloadFile(csv, 'epstein-flights-selected.csv', 'text/csv');
            showNotification(`Exported ${selectedFlights.length} selected flights`, 'success');
            closeExportModal();
        }

        function exportWithReliability() {
            const data = flightData.map((f, index) => {
                const classification = dataSourceClassification[`flight_${index}`];
                return {
                    date: formatDate(f.date),
                    flight: f.flightNo,
                    from: f.from,
                    to: f.to,
                    passengers: f.passengers.join(', '),
                    reliability: classification?.reliability || 'unclassified',
                    confidence: classification?.confidence || 0,
                    source: classification?.source || 'unknown'
                };
            });
            
            const csv = [
                Object.keys(data[0]).join(','),
                ...data.map(row => Object.values(row).map(v => `"${v}"`).join(','))
            ].join('\n');
            
            downloadFile(csv, 'epstein-flights-with-reliability.csv', 'text/csv');
            showNotification('Flight data with reliability scores exported', 'success');
            closeExportModal();
        }

        function exportSummaryReport() {
            const stats = calculateAdvancedStatistics();
            const reliabilityStats = calculateReliabilityStatistics();
            const topConnections = Array.from(generateConnectionsMap().entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const report = {
                reportTitle: "Epstein Flight Logs - Executive Summary",
                generatedAt: new Date().toISOString(),
                overview: {
                    totalFlights: flightData.length,
                    totalPassengers: Object.keys(passengerData).length,
                    avgFlightsPerPassenger: stats.avgFlightsPerPassenger,
                    peakActivityPeriod: stats.peakFlightPeriod,
                    routeEfficiency: stats.routeEfficiency
                },
                reliability: {
                    verified: reliabilityStats.verified,
                    probable: reliabilityStats.probable,
                    unverified: reliabilityStats.unverified,
                    disputed: reliabilityStats.disputed,
                    overallConfidence: (reliabilityStats.highConfidence / Object.keys(dataSourceClassification).length * 100).toFixed(1) + '%'
                },
                topConnections: topConnections.map(([connection, count]) => ({
                    passengers: connection,
                    coTravelCount: count
                })),
                methodology: "Analysis based on publicly available flight log data with reliability scoring",
                disclaimer: "This report is for investigative and educational purposes only"
            };
            
            const json = JSON.stringify(report, null, 2);
            downloadFile(json, 'epstein-flights-summary-report.json', 'application/json');
            showNotification('Summary report exported', 'success');
            closeExportModal();
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Initialize URL parameters on page load
        function loadFromUrlParameters() {
            const params = new URLSearchParams(window.location.search);
            
            // Set user mode
            const mode = params.get('mode');
            if (mode && ['beginner', 'intermediate', 'advanced', 'expert'].includes(mode)) {
                setUserMode(mode);
            }
            
            // Set filters
            const passenger = params.get('passenger');
            if (passenger) {
                const passengerInput = document.getElementById('passengerSearch');
                if (passengerInput) passengerInput.value = passenger;
            }
            
            const startDate = params.get('start');
            if (startDate) {
                const startInput = document.getElementById('startDate');
                if (startInput) startInput.value = startDate;
            }
            
            const endDate = params.get('end');
            if (endDate) {
                const endInput = document.getElementById('endDate');
                if (endInput) endInput.value = endDate;
            }
            
            const destination = params.get('dest');
            if (destination) {
                const destSelect = document.getElementById('destinationFilter');
                if (destSelect) destSelect.value = destination;
            }
            
            // Apply filters if any were set
            if (passenger || startDate || endDate || destination) {
                setTimeout(() => searchFlights(), 1000);
            }
            
            // Set selected passengers
            const selected = params.get('selected');
            if (selected) {
                const passengers = selected.split(',');
                setTimeout(() => {
                    passengers.forEach(p => selectedPassengers.add(p));
                    if (passengers.length > 0) {
                        toggleBrushingMode(); // Enable brushing mode
                        updateLinkedViews();
                    }
                }, 2000);
            }
        }


        // Create and show detailed bio card
        function showBioCard(passengerName, event) {
            // Close existing bio card
            const existingCard = document.getElementById('bioCard');
            if (existingCard) {
                existingCard.remove();
            }
            
            const trimmedName = passengerName.trim();
            const passengerInfo = passengerData[trimmedName];
            const identity = passengerIdentities[trimmedName];
            
            if (!passengerInfo && !identity) return;
            
            // Create bio card
            const bioCard = document.createElement('div');
            bioCard.id = 'bioCard';
            bioCard.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--card-bg);
                border: 2px solid var(--primary-color);
                border-radius: 15px;
                padding: 25px;
                max-width: 500px;
                width: 90%;
                z-index: 10000;
                box-shadow: 0 20px 40px rgba(0,0,0,0.5);
                color: white;
                font-family: 'Segoe UI', sans-serif;
            `;
            
            // Get flight details for this passenger
            const flights = passengerInfo ? passengerInfo.flights : [];
            const flightCount = flights.length;
            const uniqueDestinations = flights ? [...new Set(flights.map(f => f.to))].length : 0;
            
            // Determine passenger category for styling
            let categoryColor = 'var(--secondary-color)';
            let categoryIcon = '👤';
            if (trimmedName.toLowerCase().includes('epstein')) {
                categoryColor = 'var(--danger-color)';
                categoryIcon = '🚨';
            } else if (trimmedName.toLowerCase().includes('maxwell')) {
                categoryColor = 'var(--danger-color)';
                categoryIcon = '⚖️';
            } else if (trimmedName.includes('Visoski') || trimmedName.includes('Hammond')) {
                categoryColor = 'var(--accent-color)';
                categoryIcon = '✈️';
            } else if (trimmedName.toLowerCase().includes('female') || /^\d+\s/.test(trimmedName)) {
                categoryColor = 'var(--warning-color)';
                categoryIcon = '⚠️';
            }
            
            bioCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <h3 style="color: ${categoryColor}; margin: 0; font-size: 1.4em; display: flex; align-items: center; gap: 10px;">
                            ${categoryIcon} ${trimmedName}
                        </h3>
                        <p style="color: var(--secondary-color); margin: 5px 0 0 0; font-size: 0.9em;">
                            ${identity || 'Limited information available'}
                        </p>
                    </div>
                    <button onclick="closeBioCard()" style="
                        background: none;
                        border: none;
                        color: var(--primary-color);
                        font-size: 24px;
                        cursor: pointer;
                        padding: 0;
                        width: 30px;
                        height: 30px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">×</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; color: var(--primary-color); font-weight: bold;">${flightCount}</div>
                        <div style="font-size: 12px; color: var(--secondary-color);">Total Flights</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; color: var(--accent-color); font-weight: bold;">${uniqueDestinations}</div>
                        <div style="font-size: 12px; color: var(--secondary-color);">Destinations</div>
                    </div>
                </div>
                
                ${flightCount > 0 ? `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 10px;">Recent Flight Activity</h4>
                    <div style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 5px; padding: 10px;">
                        ${flights.slice(-10).reverse().map(flight => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="font-size: 13px;">${formatDate(flight.date)}</span>
                                <span style="font-size: 13px; color: var(--secondary-color);">${createAirportTooltip(flight.from)} → ${createAirportTooltip(flight.to)}</span>
                                <span style="font-size: 12px; color: var(--accent-color);">#${flight.flightNo}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <div style="text-align: center;">
                    <button onclick="filterByPassenger('${trimmedName}')" style="
                        background: var(--primary-color);
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 25px;
                        cursor: pointer;
                        margin-right: 10px;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='var(--danger-color)'" onmouseout="this.style.background='var(--primary-color)'">
                        🔍 Filter Flights
                    </button>
                    <button onclick="closeBioCard()" style="
                        background: var(--secondary-color);
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 25px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">Close</button>
                </div>
            `;
            
            document.body.appendChild(bioCard);
            
            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.id = 'bioCardBackdrop';
            backdrop.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                z-index: 8500;
            `;
            backdrop.onclick = closeBioCard;
            document.body.appendChild(backdrop);
        }
        
        // Close bio card
        function closeBioCard() {
            const bioCard = document.getElementById('bioCard');
            const backdrop = document.getElementById('bioCardBackdrop');
            if (bioCard) bioCard.remove();
            if (backdrop) backdrop.remove();
        }

        // Enhanced Map Layer System
        function initializeMapLayers() {
            mapLayers = {
                'dark': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '© OpenStreetMap contributors © CARTO',
                    subdomains: 'abcd',
                    maxZoom: 19
                }),
                'light': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '© OpenStreetMap contributors © CARTO',
                    subdomains: 'abcd',
                    maxZoom: 19
                }),
                'satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles © Esri',
                    maxZoom: 19
                }),
                'terrain': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data: © OpenStreetMap contributors, © OpenTopoMap',
                    maxZoom: 17
                })
            };
        }

        function switchMapLayer(layerName) {
            // Remove current layer
            if (currentMapLayer && mapLayers[currentMapLayer]) {
                map.removeLayer(mapLayers[currentMapLayer]);
            }
            
            // Add new layer
            if (mapLayers[layerName]) {
                mapLayers[layerName].addTo(map);
                currentMapLayer = layerName;
                
                // Update selector
                const selector = document.getElementById('mapLayerSelector');
                if (selector) {
                    selector.value = layerName;
                }
                
                showNotification(`Switched to ${layerName} map layer`, 'info');
            }
        }

        function switchOverlay(overlayType) {
            currentOverlay = overlayType;
            
            switch (overlayType) {
                case 'heatmap':
                    showHeatmapOverlay();
                    break;
                case 'clusters':
                    showClusterOverlay();
                    break;
                case 'paths':
                    showFlightPaths();
                    break;
                case 'all':
                    showAllOverlays();
                    break;
            }
            
            showNotification(`Switched to ${overlayType} overlay`, 'info');
        }

        function showHeatmapOverlay() {
            // Clear existing overlays
            clearOverlays();
            
            // Create heatmap data
            const heatData = [];
            flightData.forEach(flight => {
                const fromAirport = airports[flight.from] || airports[flight.from.toUpperCase()];
                const toAirport = airports[flight.to] || airports[flight.to.toUpperCase()];
                
                if (fromAirport) {
                    heatData.push([fromAirport.lat, fromAirport.lng, 0.5]);
                }
                if (toAirport) {
                    heatData.push([toAirport.lat, toAirport.lng, 0.5]);
                }
            });
            
            // Add heatmap layer
            if (L.heatLayer && heatData.length > 0) {
                heatmapLayer = L.heatLayer(heatData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 17
                }).addTo(map);
                
                // Show heatmap legend
                document.getElementById('heatmapLegend').style.display = 'block';
                document.getElementById('flightPathLegend').style.display = 'none';
            }
        }

        function showClusterOverlay() {
            clearOverlays();
            
            // Create marker cluster group
            if (L.markerClusterGroup) {
                clusterLayer = L.markerClusterGroup({
                    chunkedLoading: true,
                    maxClusterRadius: 50
                });
                
                // Add airport markers to cluster
                Object.keys(airports).forEach(code => {
                    const airport = airports[code];
                    const flightCount = flightData.filter(f => 
                        f.from === code || f.to === code
                    ).length;
                    
                    const marker = L.marker([airport.lat, airport.lng])
                        .bindPopup(`
                            <strong>${code}</strong><br>
                            ${airport.name}<br>
                            <strong>Flights:</strong> ${flightCount}
                        `);
                    
                    clusterLayer.addLayer(marker);
                });
                
                map.addLayer(clusterLayer);
            }
        }

        function showFlightPaths() {
            clearOverlays();
            drawFlightPaths();
            document.getElementById('flightPathLegend').style.display = 'block';
            document.getElementById('heatmapLegend').style.display = 'none';
        }

        function showAllOverlays() {
            clearOverlays();
            drawFlightPaths();
            showHeatmapOverlay();
            document.getElementById('flightPathLegend').style.display = 'block';
            document.getElementById('heatmapLegend').style.display = 'block';
        }

        function clearOverlays() {
            // Clear flight paths
            flightPaths.forEach(path => map.removeLayer(path));
            flightPaths = [];
            
            // Clear heatmap
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
                heatmapLayer = null;
            }
            
            // Clear clusters
            if (clusterLayer) {
                map.removeLayer(clusterLayer);
                clusterLayer = null;
            }
            
            // Hide legends
            document.getElementById('heatmapLegend').style.display = 'none';
            document.getElementById('flightPathLegend').style.display = 'none';
        }

        function addAirportMarkers() {
            Object.keys(airports).forEach(code => {
                const airport = airports[code];
                const flightCount = flightData.filter(f => 
                    f.from === code || f.to === code
                ).length;
                
                // Create custom icon based on flight frequency
                let iconColor = '#4ecdc4';
                if (flightCount > 50) iconColor = '#ff0000';
                else if (flightCount > 20) iconColor = '#ff6b6b';
                else if (flightCount > 10) iconColor = '#ffa500';
                
                const customIcon = L.divIcon({
                    className: 'custom-airport-marker',
                    html: `<div style="
                        background: ${iconColor};
                        width: 12px;
                        height: 12px;
                        border-radius: 50%;
                        border: 2px solid white;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    "></div>`,
                    iconSize: [12, 12],
                    iconAnchor: [6, 6]
                });
                
                L.marker([airport.lat, airport.lng], { icon: customIcon })
                    .addTo(map)
                    .bindPopup(`
                        <div style="min-width: 200px;">
                            <strong style="color: ${iconColor};">${code}</strong><br>
                            <strong>${airport.name}</strong><br>
                            <em>${airport.location || 'Location not specified'}</em><br>
                            <br>
                            <strong>Flight Activity:</strong> ${flightCount} flights<br>
                            ${airport.description ? `<br><em>${airport.description}</em>` : ''}
                        </div>
                    `);
            });
        }

        // Timeline Control System
        function prepareTimelineData() {
            // Sort flights chronologically
            timelineData = [...flightData].sort((a, b) => a.date.localeCompare(b.date));
            
            // Update timeline slider max value
            const slider = document.getElementById('timeSlider');
            if (slider) {
                slider.max = timelineData.length - 1;
            }
        }

        function toggleTimeSlider() {
            const container = document.getElementById('timeSliderContainer');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                updateTimelinePosition(0);
                showNotification('Timeline controls activated', 'info');
            } else {
                container.style.display = 'none';
                // Show all flights again
                showAllFlights();
                showNotification('Timeline controls deactivated', 'info');
            }
        }

        function updateTimelinePosition(value) {
            currentTimeIndex = parseInt(value);
            
            if (timelineData.length === 0) return;
            
            const maxIndex = Math.min(currentTimeIndex, timelineData.length - 1);
            const visibleFlights = timelineData.slice(0, maxIndex + 1);
            
            // Update display
            updateTimelineDisplay(visibleFlights);
            
            // Update map with visible flights
            showFlightsOnTimeline(visibleFlights);
        }

        function updateTimelineDisplay(visibleFlights) {
            if (visibleFlights.length === 0) {
                document.getElementById('currentTimeDisplay').textContent = 'No flights';
                document.getElementById('totalFlightsDisplay').textContent = '0 flights visible';
                return;
            }
            
            const startDate = formatDate(visibleFlights[0].date);
            const endDate = formatDate(visibleFlights[visibleFlights.length - 1].date);
            
            document.getElementById('currentTimeDisplay').textContent = 
                visibleFlights.length === 1 ? startDate : `${startDate} - ${endDate}`;
            document.getElementById('totalFlightsDisplay').textContent = 
                `${visibleFlights.length} flights visible`;
        }

        function showFlightsOnTimeline(visibleFlights) {
            // Clear existing paths
            flightPaths.forEach(path => map.removeLayer(path));
            flightPaths = [];
            
            // Draw paths for visible flights only
            visibleFlights.forEach(flight => {
                drawSingleFlightPath(flight);
            });
        }

        function drawSingleFlightPath(flight) {
            const fromAirport = airports[flight.from] || airports[flight.from.toUpperCase()];
            const toAirport = airports[flight.to] || airports[flight.to.toUpperCase()];
            
            if (!fromAirport || !toAirport) return;
            
            const latlngs = [[fromAirport.lat, fromAirport.lng], [toAirport.lat, toAirport.lng]];
            
            // Determine path color based on route type
            let color = '#4ecdc4';
            if (flight.from === 'TIST' || flight.to === 'TIST') {
                color = '#ff0000';
            } else if (flight.from === 'MBPV' || flight.to === 'MBPV') {
                color = '#ff6b6b';
            } else if ((flight.from === 'TEB' && flight.to === 'PBI') || 
                      (flight.from === 'PBI' && flight.to === 'TEB')) {
                color = '#ffa500';
            }
            
            const polyline = L.polyline(latlngs, {
                color: color,
                weight: 2,
                opacity: 0.7
            }).addTo(map);
            
            // Add popup
            const passengerList = flight.passengers.join(', ');
            polyline.bindPopup(`
                <strong>Flight ${flight.flightNo}</strong><br>
                <strong>Date:</strong> ${formatDate(flight.date)}<br>
                <strong>Route:</strong> ${flight.from} → ${flight.to}<br>
                <strong>Passengers:</strong> ${passengerList}
            `);
            
            flightPaths.push(polyline);
        }

        function showAllFlights() {
            clearOverlays();
            drawFlightPaths();
            document.getElementById('flightPathLegend').style.display = 'block';
        }

        function playTimelineAnimation() {
            const playButton = document.getElementById('playButton');
            
            if (timelineAnimation) {
                // Stop animation
                clearInterval(timelineAnimation);
                timelineAnimation = null;
                playButton.textContent = '▶️';
                return;
            }
            
            // Start animation
            playButton.textContent = '⏸️';
            timelineAnimation = setInterval(() => {
                currentTimeIndex++;
                
                if (currentTimeIndex >= timelineData.length) {
                    clearInterval(timelineAnimation);
                    timelineAnimation = null;
                    playButton.textContent = '▶️';
                    currentTimeIndex = timelineData.length - 1;
                    return;
                }
                
                const slider = document.getElementById('timeSlider');
                slider.value = currentTimeIndex;
                updateTimelinePosition(currentTimeIndex);
                
            }, 1000 / playbackSpeed);
        }

        function setPlaybackSpeed(speed) {
            playbackSpeed = parseFloat(speed);
            
            // Restart animation with new speed if it's running
            if (timelineAnimation) {
                const wasPlaying = true;
                playTimelineAnimation(); // Stop
                if (wasPlaying) {
                    playTimelineAnimation(); // Start again with new speed
                }
            }
        }

        function toggle3DView() {
            is3DMode = !is3DMode;
            if (is3DMode) {
                showNotification('3D View - Feature coming in Phase 3', 'info');
            } else {
                showNotification('2D View activated', 'info');
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = 
                type === 'error' ? 'var(--danger-color)' :
                type === 'warning' ? 'var(--warning-color)' :
                type === 'success' ? 'var(--success-color)' :
                'var(--primary-color)';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Back to top functionality
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Touch gesture support
        function initializeTouchSupport() {
            // Detect touch capability
            if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
                document.body.classList.add('touch-enabled');
                
                // Add touch-specific behaviors
                addSwipeGestures();
                
                // Hide mobile loading after initialization
                setTimeout(() => {
                    const mobileLoading = document.getElementById('mobileLoading');
                    if (mobileLoading) {
                        mobileLoading.style.display = 'none';
                    }
                }, 2000);
            }
        }

        // Basic swipe gesture support
        function addSwipeGestures() {
            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            
            document.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            });
            
            document.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipeGesture();
            });
            
            function handleSwipeGesture() {
                const swipeThreshold = 50;
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                
                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                    if (Math.abs(deltaX) > swipeThreshold) {
                        if (deltaX > 0) {
                            // Swipe right - could navigate to previous section
                            console.log('Swipe right detected');
                        } else {
                            // Swipe left - could navigate to next section
                            console.log('Swipe left detected');
                        }
                    }
                } else {
                    if (Math.abs(deltaY) > swipeThreshold) {
                        if (deltaY > 0) {
                            // Swipe down
                            console.log('Swipe down detected');
                        } else {
                            // Swipe up
                            console.log('Swipe up detected');
                        }
                    }
                }
            }
        }

        // Responsive breakpoint detection
        function detectBreakpoint() {
            const width = window.innerWidth;
            if (width < 768) {
                return 'mobile';
            } else if (width < 1024) {
                return 'tablet';
            } else {
                return 'desktop';
            }
        }

        // Adaptive interface based on screen size
        function adaptInterfaceToBreakpoint() {
            const breakpoint = detectBreakpoint();
            document.body.classList.remove('breakpoint-mobile', 'breakpoint-tablet', 'breakpoint-desktop');
            document.body.classList.add(`breakpoint-${breakpoint}`);
            
            // Adjust map height based on screen size
            const mapElement = document.getElementById('flightMap');
            if (mapElement && map) {
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        }

        // Utility function for debouncing resize events
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', () => {
            initializeUserMode();
            initializeTouchSupport();
            adaptInterfaceToBreakpoint();
            initializeMap();
            loadFlightData();
            
            // Populate destination filter
            setTimeout(() => {
                const destinations = [...new Set(flightData.map(f => f.to))].sort();
                const select = document.getElementById('destinationFilter');
                destinations.forEach(dest => {
                    const option = document.createElement('option');
                    option.value = dest;
                    option.textContent = `${dest} - ${airports[dest]?.name || 'Unknown'}`;
                    select.appendChild(option);
                });
            }, 1000);

            // Back to top button functionality
            window.addEventListener('scroll', function() {
                const backToTop = document.getElementById('backToTop');
                if (window.pageYOffset > 300) {
                    backToTop.style.display = 'block';
                } else {
                    backToTop.style.display = 'none';
                }
            });
            
            // Initialize advanced search after data loads
            setTimeout(() => {
                initializeAdvancedSearch();
                initializeEvidenceClassification();
            }, 2000);
            
            // Handle window resize for responsive behavior
            window.addEventListener('resize', debounce(() => {
                adaptInterfaceToBreakpoint();
            }, 250));
            
            // Load settings from URL parameters
            setTimeout(() => {
                loadFromUrlParameters();
            }, 3000);
            
            // Initialize performance monitoring
            setTimeout(() => {
                monitorPerformance();
                optimizeEventHandlers();
            }, 1000);
        });

        // Performance Optimization Functions
        function monitorPerformance() {
            const startTime = performance.now();
            
            setTimeout(() => {
                const loadTime = performance.now() - startTime;
                console.log(`✨ Enhanced Flight Logs Platform loaded in ${loadTime.toFixed(2)}ms`);
                
                if (loadTime > 3000) {
                    console.warn('⚠️ Load time exceeded 3 seconds');
                    showNotification('Platform loaded with performance optimizations active', 'info');
                } else {
                    console.log('✅ Performance target met: <3s load time');
                }
            }, 100);
            
            // Monitor Chart.js performance
            if (typeof Chart !== 'undefined') {
                Chart.defaults.animation = { duration: 300 };
                Chart.defaults.responsive = true;
                Chart.defaults.maintainAspectRatio = false;
                console.log('⚡ Chart.js optimized for faster rendering');
            }
        }

        function optimizeEventHandlers() {
            // Debounce search input for better performance
            const searchInput = document.getElementById('passengerNameSearch');
            if (searchInput) {
                let searchTimeout;
                const originalHandler = searchInput.onkeyup;
                searchInput.onkeyup = function(e) {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        if (originalHandler) originalHandler.call(this, e);
                    }, 300); // 300ms debounce for better performance
                };
            }
            
            console.log('🚀 Event handlers optimized with debouncing');
        }
    </script>
    
    <!-- License Notice -->
    <div style="position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); color: #ccc; padding: 8px 12px; border-radius: 5px; font-size: 11px; z-index: 1000;">
        <a href="LICENSE" style="color: #ff6b6b; text-decoration: none;">Open License</a> | Non-commercial use only
    </div>
</body>
</html>